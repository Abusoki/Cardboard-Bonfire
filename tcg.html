<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Companion</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        /* ============================================================
           THEME SYSTEM – CSS Custom Properties
           Default: dark-purple  |  light  |  dark-red
        ============================================================ */
        :root,
        [data-theme="dark-purple"] {
            --bg-primary: #020617;
            --bg-secondary: #0f172a;
            --bg-card: #1e293b;
            --bg-elevated: #334155;
            --accent: #9333ea;
            --accent-hover: #a855f7;
            --accent-light: rgba(147, 51, 234, 0.15);
            --accent-ring: rgba(147, 51, 234, 0.5);
            --text-primary: #f1f5f9;
            --text-muted: #94a3b8;
            --text-faint: #475569;
            --border: #1e293b;
            --border-light: #334155;
            --scrollbar-track: #0f172a;
            --scrollbar-thumb: #334155;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #f1f5f9;
            --bg-elevated: #e2e8f0;
            --accent: #7c3aed;
            --accent-hover: #6d28d9;
            --accent-light: rgba(124, 58, 237, 0.1);
            --accent-ring: rgba(124, 58, 237, 0.4);
            --text-primary: #0f172a;
            --text-muted: #475569;
            --text-faint: #94a3b8;
            --border: #e2e8f0;
            --border-light: #cbd5e1;
            --scrollbar-track: #e2e8f0;
            --scrollbar-thumb: #94a3b8;
        }

        [data-theme="dark-red"] {
            --bg-primary: #0a0000;
            --bg-secondary: #120808;
            --bg-card: #1f0d0d;
            --bg-elevated: #2d1212;
            --accent: #dc2626;
            --accent-hover: #ef4444;
            --accent-light: rgba(220, 38, 38, 0.15);
            --accent-ring: rgba(220, 38, 38, 0.5);
            --text-primary: #fef2f2;
            --text-muted: #fca5a5;
            --text-faint: #7f1d1d;
            --border: #1f0d0d;
            --border-light: #450a0a;
            --scrollbar-track: #120808;
            --scrollbar-thumb: #450a0a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-light);
        }

        /* Theme-aware utility classes */
        .theme-bg-primary {
            background: var(--bg-primary) !important;
        }

        .theme-bg-secondary {
            background: var(--bg-secondary) !important;
        }

        .theme-bg-card {
            background: var(--bg-card) !important;
        }

        .theme-bg-elevated {
            background: var(--bg-elevated) !important;
        }

        .theme-accent {
            background: var(--accent) !important;
        }

        .theme-accent-light {
            background: var(--accent-light) !important;
        }

        .theme-text {
            color: var(--text-primary) !important;
        }

        .theme-text-muted {
            color: var(--text-muted) !important;
        }

        .theme-text-accent {
            color: var(--accent) !important;
        }

        .theme-border {
            border-color: var(--border) !important;
        }

        .theme-border-light {
            border-color: var(--border-light) !important;
        }

        .theme-ring {
            --tw-ring-color: var(--accent-ring) !important;
        }

        /* Nav item active state */
        .nav-active {
            background: var(--accent) !important;
            color: #fff !important;
        }

        .nav-item:hover:not(.nav-active) {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        /* Rotation Classes */
        .rotate-0 {
            transform: rotate(0deg);
        }

        .rotate-90 {
            transform: rotate(90deg);
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        .rotate-270 {
            transform: rotate(270deg);
        }

        /* Animation for Spin */
        @keyframes spin-slow {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }

        @keyframes pulse-gold {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(234, 179, 8, 0.5);
                border-color: rgba(234, 179, 8, 0.8);
            }

            50% {
                box-shadow: 0 0 30px rgba(234, 179, 8, 0.8);
                border-color: rgba(234, 179, 8, 1);
            }
        }

        .winner-glow {
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-warning {

            0%,
            100% {
                box-shadow: 0 0 6px rgba(251, 191, 36, 0.6);
            }

            50% {
                box-shadow: 0 0 14px rgba(251, 191, 36, 0.9);
            }
        }

        .cmd-warning {
            animation: pulse-warning 1.2s infinite;
        }

        @keyframes pulse-lethal {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(239, 68, 68, 0.7);
            }

            50% {
                box-shadow: 0 0 18px rgba(239, 68, 68, 1);
            }
        }

        .cmd-lethal {
            animation: pulse-lethal 0.7s infinite;
        }

        /* Mobile Scrolling Fixes */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }

        /* Life graph */
        .life-graph-dot {
            transition: r 0.15s;
        }

        .life-graph-dot:hover {
            r: 5;
        }

        /* Settings theme swatch */
        .theme-swatch {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .theme-swatch:hover {
            transform: scale(1.04);
        }

        .theme-swatch.selected {
            box-shadow: 0 0 0 3px var(--accent), 0 0 0 6px var(--accent-ring);
            transform: scale(1.04);
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 h-[100dvh] overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, setDoc, getDoc, increment, serverTimestamp, deleteDoc, runTransaction, writeBatch, deleteField, arrayRemove, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- Configuration & Global Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA_mz_fVsph8VHfCEG__9sWg_ZvwYX5_6E",
            authDomain: "mtg-life-tool.firebaseapp.com",
            projectId: "mtg-life-tool",
            storageBucket: "mtg-life-tool.appspot.com",
            messagingSenderId: "36730058988",
            appId: "1:36730058988:web:757e2d9620593b4f65022a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Icons ---
        const Icon = ({ path, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {path}
            </svg>
        );

        const Icons = {
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></>} />,
            Shield: (p) => <Icon {...p} path={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />} />,
            Skull: (p) => <Icon {...p} path={<><path d="m12.5 17-.5-1-.5 1h1z" /><path d="M15 22a1 1 0 0 0 1-1v-1a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20v1a1 1 0 0 0 1 1z" /><circle cx="15" cy="12" r="1" /><circle cx="9" cy="12" r="1" /></>} />,
            Menu: (p) => <Icon {...p} path={<><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>} />,
            Wifi: (p) => <Icon {...p} path={<><path d="M12 20h.01" /><path d="M2 8.82a15 15 0 0 1 20 0" /><path d="M5 12.859a10 10 0 0 1 14 0" /><path d="M8.5 16.429a5 5 0 0 1 7 0" /></>} />,
            RotateCcw: (p) => <Icon {...p} path={<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></>} />,
            Crown: (p) => <Icon {...p} path={<path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7z" />} />,
            ExternalLink: (p) => <Icon {...p} path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" x2="21" y1="14" y2="3" /></>} />,
            BarChart2: (p) => <Icon {...p} path={<><line x1="18" x2="18" y1="20" y2="10" /><line x1="12" x2="12" y1="20" y2="4" /><line x1="6" x2="6" y1="20" y2="14" /></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></>} />,
            Mail: (p) => <Icon {...p} path={<><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" /><polyline points="22,6 12,13 2,6" /></>} />,
            Sliders: (p) => <Icon {...p} path={<><line x1="4" x2="4" y1="21" y2="14" /><line x1="4" x2="4" y1="10" y2="3" /><line x1="12" x2="12" y1="21" y2="12" /><line x1="12" x2="12" y1="8" y2="3" /><line x1="20" x2="20" y1="21" y2="16" /><line x1="20" x2="20" y1="12" y2="3" /><line x1="1" x2="7" y1="14" y2="14" /><line x1="9" x2="15" y1="8" y2="8" /><line x1="17" x2="23" y1="16" y2="16" /></>} />,
            Sword: (p) => <Icon {...p} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5" /><line x1="13" x2="19" y1="19" y2="13" /><line x1="16" x2="20" y1="16" y2="20" /><line x1="19" x2="21" y1="21" y2="19" /></>} />,
            Droplet: (p) => <Icon {...p} path={<path d="M12 22a7 7 0 0 0 7-7c0-2-2-3-2-3L12 2 7 12s-2 1-2 3a7 7 0 0 0 7 7z" />} />,
            RotateCw: (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></>} />,
            Lock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>} />,
            Unlock: (p) => <Icon {...p} path={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></>} />,
            Share: (p) => <Icon {...p} path={<><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" x2="15.42" y1="13.51" y2="17.49" /><line x1="15.41" x2="8.59" y1="6.51" y2="10.49" /></>} />,
            Copy: (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2" /><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" /></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>} />,
            MessageCircle: (p) => <Icon {...p} path={<><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" /></>} />,
            Send: (p) => <Icon {...p} path={<><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>} />,
            Dices: (p) => <Icon {...p} path={<><rect x="2" y="2" width="20" height="20" rx="5" ry="5" /><path d="M16 8h.01" /><path d="M8 8h.01" /><path d="M8 16h.01" /><path d="M16 16h.01" /><path d="M12 12h.01" /></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></>} />,
            Wrench: (p) => <Icon {...p} path={<><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></>} />,
            Refresh: (p) => <Icon {...p} path={<><path d="M23 4v6h-6" /><path d="M1 20v-6h6" /><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" /></>} />,
            Book: (p) => <Icon {...p} path={<><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" /><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" /></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6" />} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6" />} />,
            LogOut: (p) => <Icon {...p} path={<g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></g>} />,
            AlertTriangle: (p) => <Icon {...p} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3" /><path d="M12 9v4" /><path d="M12 17h.01" /></>} />,
            Undo: (p) => <Icon {...p} path={<><path d="M3 7v6h6" /><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" /></>} />,
            Redo: (p) => <Icon {...p} path={<><path d="M21 7v6h-6" /><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13" /></>} />,
        };

        // --- Helpers ---
        const updateCommanderStat = async (commander) => {
            if (!commander || !commander.name) return;
            const statRef = doc(db, 'artifacts', appId, 'public', 'data', 'commander_stats', commander.name);
            try {
                await setDoc(statRef, {
                    name: commander.name,
                    image: commander.image,
                    fullImage: commander.fullImage,
                    artist: commander.artist || 'Unknown',
                    count: increment(1),
                    lastPlayed: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Error updating stats:", e);
            }
        };

        const recordDeathStats = async (players) => {
            if (!players || players.length === 0) return;

            const deaths = {
                poison: 0,
                commander: 0,
                milled: 0,
                standard: 0
            };

            players.forEach(p => {
                if (p.isDead) {
                    if (p.milled) {
                        deaths.milled++;
                    } else if (p.poison >= 10) {
                        deaths.poison++;
                    } else if (Object.values(p.commanderDamage || {}).some(d => d >= 21)) {
                        deaths.commander++;
                    } else {
                        deaths.standard++; // Life loss or conceded
                    }
                }
            });

            if (Object.values(deaths).some(v => v > 0)) {
                const statsRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_stats', 'deaths');
                try {
                    await setDoc(statsRef, {
                        poison: increment(deaths.poison),
                        commander: increment(deaths.commander),
                        milled: increment(deaths.milled),
                        standard: increment(deaths.standard)
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving death stats:", e);
                }
            }
        };

        // --- User Profile Helpers ---
        const getUserProfile = async (uid) => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            const snap = await getDoc(docRef);
            return snap.exists() ? snap.data() : null;
        };

        const updateUserProfile = async (uid, data) => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: true });
        };

        const incrementUserStats = async (uid, { wins = 0, gamesPlayed = 0 }) => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            await setDoc(docRef, {
                stats: {
                    wins: increment(wins),
                    gamesPlayed: increment(gamesPlayed)
                },
                lastActive: serverTimestamp()
            }, { merge: true });
        };

        // --- Social Helpers ---
        const followUser = async (currentUid, targetUid) => {
            if (!currentUid || !targetUid || currentUid === targetUid) return;
            const batch = writeBatch(db);
            const currentUserRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUid);
            const targetUserRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid);

            batch.set(currentUserRef, { following: arrayUnion(targetUid) }, { merge: true });
            batch.set(targetUserRef, { followers: arrayUnion(currentUid) }, { merge: true });
            await batch.commit();
        };

        const unfollowUser = async (currentUid, targetUid) => {
            if (!currentUid || !targetUid) return;
            const batch = writeBatch(db);
            const currentUserRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUid);
            const targetUserRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid);

            // Note: arrayRemove is valid in set with merge too, but technically update is cleaner if doc exists. 
            // We assume docs exist for registered users.
            batch.update(currentUserRef, { following: arrayRemove(targetUid) });
            batch.update(targetUserRef, { followers: arrayRemove(currentUid) });
            await batch.commit();
        };

        // --- MTG Color Identities ---
        const MTG_IDENTITIES = {
            // Mono
            'White': { colors: ['#F0F2C0'], symbol: 'prod/w' },
            'Blue': { colors: ['#B3CEEA'], symbol: 'prod/u' },
            'Black': { colors: ['#A69F9D'], symbol: 'prod/b' },
            'Red': { colors: ['#EBA082'], symbol: 'prod/r' },
            'Green': { colors: ['#C4D3CA'], symbol: 'prod/g' },
            'Colorless': { colors: ['#CBCBCB'], symbol: 'prod/c' },
            // Guilds (2 Color)
            'Azorius': { colors: ['#F0F2C0', '#B3CEEA'], description: 'White/Blue' },
            'Dimir': { colors: ['#B3CEEA', '#A69F9D'], description: 'Blue/Black' },
            'Rakdos': { colors: ['#A69F9D', '#EBA082'], description: 'Black/Red' },
            'Gruul': { colors: ['#EBA082', '#C4D3CA'], description: 'Red/Green' },
            'Selesnya': { colors: ['#F0F2C0', '#C4D3CA'], description: 'White/Green' },
            'Orzhov': { colors: ['#F0F2C0', '#A69F9D'], description: 'White/Black' },
            'Izzet': { colors: ['#B3CEEA', '#EBA082'], description: 'Blue/Red' },
            'Golgari': { colors: ['#A69F9D', '#C4D3CA'], description: 'Black/Green' },
            'Boros': { colors: ['#F0F2C0', '#EBA082'], description: 'White/Red' },
            'Simic': { colors: ['#B3CEEA', '#C4D3CA'], description: 'Blue/Green' },
            // Shards (3 Color)
            'Bant': { colors: ['#F0F2C0', '#B3CEEA', '#C4D3CA'], description: 'WUG' },
            'Esper': { colors: ['#F0F2C0', '#B3CEEA', '#A69F9D'], description: 'WUB' },
            'Grixis': { colors: ['#B3CEEA', '#A69F9D', '#EBA082'], description: 'UBR' },
            'Jund': { colors: ['#A69F9D', '#EBA082', '#C4D3CA'], description: 'BRG' },
            'Naya': { colors: ['#F0F2C0', '#EBA082', '#C4D3CA'], description: 'WRG' },
            // Wedges (3 Color)
            'Abzan': { colors: ['#F0F2C0', '#A69F9D', '#C4D3CA'], description: 'WBG' },
            'Jeskai': { colors: ['#F0F2C0', '#B3CEEA', '#EBA082'], description: 'WUR' },
            'Sultai': { colors: ['#A69F9D', '#C4D3CA', '#B3CEEA'], description: 'BGU' },
            'Mardu': { colors: ['#F0F2C0', '#A69F9D', '#EBA082'], description: 'WBR' },
            'Temur': { colors: ['#C4D3CA', '#B3CEEA', '#EBA082'], description: 'GUR' },
            // 5 Color
            'WUBRG': { colors: ['#F0F2C0', '#B3CEEA', '#A69F9D', '#EBA082', '#C4D3CA'], description: 'All Colors' }
        };

        const IdentityIcon = ({ id, size = "w-6 h-6" }) => {
            const data = MTG_IDENTITIES[id] || MTG_IDENTITIES['Colorless'];
            const gradient = data.colors.length > 1
                ? `linear-gradient(135deg, ${data.colors.join(', ')})`
                : data.colors[0];

            return (
                <div
                    className={`${size} rounded-full shadow-inner border border-slate-600/50`}
                    style={{ background: gradient }}
                    title={id}
                />
            );
        };

        // --- Theme Context ---
        const ThemeContext = React.createContext({ theme: 'dark-purple', setTheme: () => { } });

        const ThemeProvider = ({ children }) => {
            const [theme, setThemeState] = React.useState(() => localStorage.getItem('mtg_theme') || 'dark-purple');
            const setTheme = (t) => {
                setThemeState(t);
                localStorage.setItem('mtg_theme', t);
                document.documentElement.setAttribute('data-theme', t);
            };
            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
            }, [theme]);
            return <ThemeContext.Provider value={{ theme, setTheme }}>{children}</ThemeContext.Provider>;
        };

        // --- Web Worker Heartbeat Hook ---
        const useBackgroundHeartbeat = () => {
            useEffect(() => {
                const workerScript = `
                    let intervalId;
                    self.onmessage = function(e) {
                        if (e.data === 'start') {
                            intervalId = setInterval(() => {
                                self.postMessage('tick');
                            }, 1000);
                        } else if (e.data === 'stop') {
                            clearInterval(intervalId);
                        }
                    };
                `;
                const blob = new Blob([workerScript], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                const worker = new Worker(workerUrl);
                worker.onmessage = () => { };
                worker.postMessage('start');
                return () => {
                    worker.postMessage('stop');
                    worker.terminate();
                    URL.revokeObjectURL(workerUrl);
                };
            }, []);
        };

        // --- Game Timer Hook ---
        const useGameTimer = () => {
            const [elapsed, setElapsed] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const intervalRef = useRef(null);
            const startTimeRef = useRef(null);
            const accumulatedRef = useRef(0);

            const start = () => {
                if (isRunning) return;
                startTimeRef.current = Date.now();
                setIsRunning(true);
            };
            const pause = () => {
                if (!isRunning) return;
                accumulatedRef.current += Date.now() - startTimeRef.current;
                setIsRunning(false);
            };
            const reset = () => {
                accumulatedRef.current = 0;
                startTimeRef.current = null;
                setIsRunning(false);
                setElapsed(0);
            };
            const restart = () => {
                accumulatedRef.current = 0;
                startTimeRef.current = Date.now();
                setElapsed(0);
                setIsRunning(true);
            };
            useEffect(() => {
                if (!isRunning) { clearInterval(intervalRef.current); return; }
                intervalRef.current = setInterval(() => {
                    setElapsed(accumulatedRef.current + (Date.now() - startTimeRef.current));
                }, 500);
                return () => clearInterval(intervalRef.current);
            }, [isRunning]);

            const fmt = (ms) => {
                const s = Math.floor(ms / 1000);
                const m = Math.floor(s / 60);
                return `${String(m).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
            };
            return { elapsed, isRunning, display: fmt(elapsed), start, pause, reset, restart };
        };

        // --- Life History Modal ---
        const LifeHistoryModal = ({ name, history, startLife = 40, onClose }) => {
            if (!history || history.length === 0) return (
                <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-md" onClick={onClose}>
                    <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 text-center" onClick={e => e.stopPropagation()}>
                        <div className="text-slate-400 mb-4">No life history yet.</div>
                        <button onClick={onClose} className="text-slate-400 hover:text-white">Close</button>
                    </div>
                </div>
            );

            const W = 320, H = 180, PAD = 32;
            const allLife = [startLife, ...history.map(h => h.life)];
            const minL = Math.min(...allLife) - 5;
            const maxL = Math.max(...allLife) + 5;
            const toX = (i) => PAD + (i / (allLife.length - 1 || 1)) * (W - PAD * 2);
            const toY = (l) => PAD + ((maxL - l) / (maxL - minL || 1)) * (H - PAD * 2);
            const points = allLife.map((l, i) => `${toX(i)},${toY(l)}`).join(' ');
            const areaPoints = `${toX(0)},${H - PAD} ${points} ${toX(allLife.length - 1)},${H - PAD}`;
            const lastLife = allLife[allLife.length - 1];
            const colorClass = lastLife <= 0 ? '#ef4444' : lastLife <= 10 ? '#f59e0b' : '#a855f7';

            return (
                <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
                    <div className="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                            <h3 className="font-bold text-white flex items-center gap-2">
                                <Icons.BarChart2 className="w-4 h-4 text-purple-400" /> {name} — Life History
                            </h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="p-4">
                            <svg viewBox={`0 0 ${W} ${H}`} width="100%" className="overflow-visible">
                                {/* Grid lines */}
                                {[0, 1, 2, 3].map(i => {
                                    const y = PAD + i * (H - PAD * 2) / 3;
                                    const val = Math.round(maxL - i * (maxL - minL) / 3);
                                    return <g key={i}>
                                        <line x1={PAD} y1={y} x2={W - PAD} y2={y} stroke="#334155" strokeDasharray="4,4" strokeWidth="1" />
                                        <text x={PAD - 4} y={y + 4} textAnchor="end" fill="#64748b" fontSize="9">{val}</text>
                                    </g>;
                                })}
                                {/* Zero line */}
                                {minL < 0 && maxL > 0 && <line x1={PAD} x2={W - PAD} y1={toY(0)} y2={toY(0)} stroke="#ef4444" strokeOpacity="0.4" strokeWidth="1" strokeDasharray="4,2" />}
                                {/* Area fill */}
                                <polygon points={areaPoints} fill={colorClass} fillOpacity="0.08" />
                                {/* Line */}
                                <polyline points={points} fill="none" stroke={colorClass} strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round" />
                                {/* Dots */}
                                {allLife.map((l, i) => (
                                    <circle key={i} cx={toX(i)} cy={toY(l)} r="3.5" fill={colorClass} stroke="#0f172a" strokeWidth="2" className="life-graph-dot">
                                        <title>{i === 0 ? `Start: ${l}` : `Move ${i}: ${l}`}</title>
                                    </circle>
                                ))}
                            </svg>
                            <div className="flex justify-between text-xs text-slate-500 mt-1 px-1">
                                <span>Start ({startLife})</span>
                                <span>Now ({lastLife})</span>
                            </div>
                            {history.length > 0 && (
                                <div className="mt-3 space-y-1 max-h-28 overflow-y-auto">
                                    {[...history].reverse().slice(0, 10).map((h, i) => (
                                        <div key={i} className="flex justify-between text-xs text-slate-400 border-b border-slate-800 pb-1">
                                            <span>{h.change > 0 ? `+${h.change}` : h.change}</span>
                                            <span className="font-bold text-white">{h.life}</span>
                                            <span className="text-slate-600">{new Date(h.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="p-3 bg-slate-800 border-t border-slate-700 flex justify-center">
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-sm">Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Stats Export Modal ---
        const StatsExportModal = ({ user, profile, topCommanders, deathStats, onClose }) => {
            const canvasRef = useRef(null);
            const [exporting, setExporting] = useState(false);
            const [preview, setPreview] = useState(null);

            const displayName = profile?.displayName || user?.displayName || 'Commander';
            const wins = profile?.stats?.wins || 0;
            const played = profile?.stats?.gamesPlayed || 0;
            const winRate = played ? Math.round((wins / played) * 100) : 0;
            const favColor = profile?.favoriteColor || 'Colorless';
            const favCmd = profile?.favoriteCommander;

            useEffect(() => { buildCanvas(); }, [profile, topCommanders]);

            const buildCanvas = async () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const W = 600, H = 340;
                canvas.width = W; canvas.height = H;

                // Background gradient
                const grad = ctx.createLinearGradient(0, 0, W, H);
                grad.addColorStop(0, '#0f0520');
                grad.addColorStop(1, '#0f172a');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, W, H);

                // Commander art background if available
                if (favCmd?.image) {
                    try {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = favCmd.image; });
                        ctx.globalAlpha = 0.18;
                        ctx.filter = 'blur(12px)';
                        ctx.drawImage(img, W / 2 - 20, 0, W / 2 + 20, H);
                        ctx.filter = 'none';
                        ctx.globalAlpha = 1;
                        // Right side commander portrait
                        ctx.save();
                        ctx.globalAlpha = 0.85;
                        ctx.drawImage(img, W * 0.58, 20, W * 0.38, H - 40);
                        ctx.restore();
                        // Gradient overlay on right
                        const overlay = ctx.createLinearGradient(W * 0.55, 0, W, 0);
                        overlay.addColorStop(0, 'rgba(10,3,30,1)');
                        overlay.addColorStop(0.3, 'rgba(10,3,30,0.4)');
                        overlay.addColorStop(1, 'rgba(10,3,30,0)');
                        ctx.fillStyle = overlay;
                        ctx.fillRect(0, 0, W, H);
                    } catch (e) { }
                }

                // Purple top bar
                ctx.fillStyle = '#9333ea';
                ctx.fillRect(0, 0, W, 4);

                // App branding
                ctx.fillStyle = 'rgba(147,51,234,0.2)';
                roundRect(ctx, 20, 20, 160, 28, 6);
                ctx.fill();
                ctx.font = 'bold 11px Inter, sans-serif';
                ctx.fillStyle = '#c084fc';
                ctx.fillText('⬡ MTG COMMANDER COMPANION', 30, 39);

                // Username
                ctx.font = 'bold 38px Inter, sans-serif';
                ctx.fillStyle = '#ffffff';
                ctx.fillText(displayName, 24, 100);

                // Colour identity chip
                ctx.font = '12px Inter, sans-serif';
                ctx.fillStyle = '#a78bfa';
                ctx.fillText(favColor, 26, 120);

                // Stats boxes
                const stats = [
                    { label: 'GAMES', value: played },
                    { label: 'WINS', value: wins },
                    { label: 'WIN RATE', value: winRate + '%' },
                ];
                stats.forEach((s, i) => {
                    const x = 24 + i * 130, y = 145;
                    ctx.fillStyle = 'rgba(255,255,255,0.06)';
                    roundRect(ctx, x, y, 115, 64, 10);
                    ctx.fill();
                    ctx.font = 'bold 26px Inter, sans-serif';
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(String(s.value), x + 12, y + 38);
                    ctx.font = '10px Inter, sans-serif';
                    ctx.fillStyle = '#94a3b8';
                    ctx.fillText(s.label, x + 12, y + 56);
                });

                // Top commanders section
                if (topCommanders?.length > 0) {
                    ctx.font = 'bold 11px Inter, sans-serif';
                    ctx.fillStyle = '#7c3aed';
                    ctx.fillText('TOP COMMANDERS', 24, 240);
                    for (let i = 0; i < Math.min(topCommanders.length, 3); i++) {
                        const cmd = topCommanders[i];
                        const y = 255 + i * 24;
                        ctx.font = i === 0 ? 'bold 13px Inter, sans-serif' : '12px Inter, sans-serif';
                        ctx.fillStyle = i === 0 ? '#f8fafc' : '#94a3b8';
                        ctx.fillText(`${i + 1}. ${cmd.name}`, 24, y);
                        ctx.font = '11px Inter, sans-serif';
                        ctx.fillStyle = '#6d28d9';
                        ctx.fillText(`${cmd.count}×`, 200, y);

                        if (cmd.image) {
                            try {
                                const ci = new Image(); ci.crossOrigin = 'anonymous';
                                await new Promise((res, rej) => { ci.onload = res; ci.onerror = rej; ci.src = cmd.image; });
                                ctx.save();
                                ctx.beginPath();
                                ctx.arc(14, y - 6, 8, 0, Math.PI * 2);
                                ctx.clip();
                                ctx.drawImage(ci, 6, y - 14, 16, 16);
                                ctx.restore();
                            } catch (e) { }
                        }
                    }
                }

                // Footer
                ctx.font = '10px Inter, sans-serif';
                ctx.fillStyle = '#334155';
                ctx.fillText('mtg-life-tool.web.app  •  Exported ' + new Date().toLocaleDateString(), 24, H - 14);

                setPreview(canvas.toDataURL('image/png'));
            };

            const download = () => {
                if (!preview) return;
                const a = document.createElement('a');
                a.href = preview;
                a.download = `${displayName}-mtg-stats.png`;
                a.click();
            };

            const share = async () => {
                if (!preview || !navigator.share) { download(); return; }
                try {
                    const blob = await (await fetch(preview)).blob();
                    const file = new File([blob], `${displayName}-mtg-stats.png`, { type: 'image/png' });
                    await navigator.share({ files: [file], title: 'My MTG Stats', text: `Check out my Commander stats! ${wins} wins out of ${played} games.` });
                } catch (e) { download(); }
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
                    <div className="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                            <h3 className="font-bold text-white flex items-center gap-2"><Icons.Share className="w-4 h-4 text-purple-400" /> Export Stats Card</h3>
                            <button onClick={onClose}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="p-4">
                            <canvas ref={canvasRef} className="hidden" />
                            {preview ? (
                                <img src={preview} alt="Stats Card" className="w-full rounded-xl border border-slate-700 shadow-lg" />
                            ) : (
                                <div className="h-48 flex items-center justify-center text-slate-500">Generating preview...</div>
                            )}
                        </div>
                        <div className="p-4 bg-slate-800 border-t border-slate-700 flex gap-3 justify-end">
                            <button onClick={onClose} className="text-slate-400 hover:text-white px-4 py-2 text-sm">Cancel</button>
                            {navigator.share && (
                                <button onClick={share} className="flex items-center gap-2 bg-purple-600/20 border border-purple-500/50 text-purple-200 hover:bg-purple-600 hover:text-white px-4 py-2 rounded-lg font-bold text-sm transition-all">
                                    <Icons.Share className="w-4 h-4" /> Share
                                </button>
                            )}
                            <button onClick={download} className="flex items-center gap-2 bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition-all">
                                <Icons.ExternalLink className="w-4 h-4" /> Download PNG
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // helper for canvas roundRect (Safari compat)
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y); ctx.arcTo(x + w, y, x + w, y + r, r);
            ctx.lineTo(x + w, y + h - r); ctx.arcTo(x + w, y + h, x + w - r, y + h, r);
            ctx.lineTo(x + r, y + h); ctx.arcTo(x, y + h, x, y + h - r, r);
            ctx.lineTo(x, y + r); ctx.arcTo(x, y, x + r, y, r);
            ctx.closePath();
        }

        // --- Settings Page ---
        const SettingsPage = () => {
            const { theme, setTheme } = React.useContext(ThemeContext);
            const themes = [
                { id: 'dark-purple', label: 'Dark Purple', desc: 'Default — deep space vibes', preview: ['#020617', '#9333ea', '#1e293b'] },
                { id: 'light', label: 'Light', desc: 'Clean & crisp with purple', preview: ['#f8fafc', '#7c3aed', '#e2e8f0'] },
                { id: 'dark-red', label: 'Dark Red', desc: 'Crimson battle mode', preview: ['#0a0000', '#dc2626', '#1f0d0d'] },
            ];
            return (
                <div className="absolute inset-0 p-8 overflow-y-auto scroll-container pb-24" style={{ background: 'var(--bg-primary)', color: 'var(--text-primary)' }}>
                    <div className="max-w-2xl mx-auto space-y-8">
                        <h1 className="text-3xl font-bold flex items-center gap-3" style={{ color: 'var(--text-primary)' }}>
                            <Icons.Sliders className="w-8 h-8" style={{ color: 'var(--accent)' }} /> Settings
                        </h1>

                        {/* Theme picker */}
                        <div className="p-6 rounded-2xl border" style={{ background: 'var(--bg-secondary)', borderColor: 'var(--border-light)' }}>
                            <h2 className="text-xl font-bold mb-1" style={{ color: 'var(--text-primary)' }}>Theme</h2>
                            <p className="text-sm mb-6" style={{ color: 'var(--text-muted)' }}>Changes take effect immediately and are saved for next time.</p>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                {themes.map(t => (
                                    <button
                                        key={t.id}
                                        onClick={() => setTheme(t.id)}
                                        className={`theme-swatch p-4 rounded-xl border-2 text-left transition-all ${theme === t.id ? 'selected' : ''}`}
                                        style={{ background: t.preview[0], borderColor: theme === t.id ? t.preview[1] : t.preview[2] }}
                                    >
                                        <div className="flex gap-2 mb-3">
                                            <div className="w-5 h-5 rounded-full" style={{ background: t.preview[0], border: `2px solid ${t.preview[2]}` }} />
                                            <div className="w-5 h-5 rounded-full" style={{ background: t.preview[1] }} />
                                            <div className="w-5 h-5 rounded-full" style={{ background: t.preview[2] }} />
                                        </div>
                                        <div className="font-bold text-sm" style={{ color: t.id === 'light' ? '#0f172a' : '#f1f5f9' }}>{t.label}</div>
                                        <div className="text-xs mt-0.5" style={{ color: t.id === 'light' ? '#64748b' : '#94a3b8' }}>{t.desc}</div>
                                        {theme === t.id && (
                                            <div className="mt-2 text-xs font-bold px-2 py-0.5 rounded-full inline-block" style={{ background: t.preview[1], color: '#fff' }}>Active</div>
                                        )}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Preferences (future) */}
                        <div className="p-6 rounded-2xl border" style={{ background: 'var(--bg-secondary)', borderColor: 'var(--border-light)' }}>
                            <h2 className="text-xl font-bold mb-4" style={{ color: 'var(--text-primary)' }}>Preferences</h2>
                            <div className="space-y-3 opacity-50 pointer-events-none select-none">
                                {['Starting Life Total (40)', 'Auto-detect Winner', 'Sound Effects', 'Haptic Feedback'].map(pref => (
                                    <div key={pref} className="flex items-center justify-between p-3 rounded-lg" style={{ background: 'var(--bg-card)' }}>
                                        <span className="text-sm" style={{ color: 'var(--text-muted)' }}>{pref}</span>
                                        <div className="w-10 h-5 rounded-full" style={{ background: 'var(--bg-elevated)' }} />
                                    </div>
                                ))}
                                <p className="text-xs text-center pt-2" style={{ color: 'var(--text-faint)' }}>Coming soon</p>
                            </div>
                        </div>

                        {/* About */}
                        <div className="p-6 rounded-2xl border" style={{ background: 'var(--bg-secondary)', borderColor: 'var(--border-light)' }}>
                            <h2 className="text-xl font-bold mb-2" style={{ color: 'var(--text-primary)' }}>About</h2>
                            <p className="text-sm" style={{ color: 'var(--text-muted)' }}>MTG Commander Companion — v2.28.0</p>
                            <p className="text-xs mt-1" style={{ color: 'var(--text-faint)' }}>Not affiliated with Wizards of the Coast.</p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Components ---

        // 1. Game Tools Modal (Unchanged)
        const GameToolsModal = ({ players, onClose }) => {
            const [activeTab, setActiveTab] = useState('first');
            const [result, setResult] = useState(null);
            const [animating, setAnimating] = useState(false);

            const spinForFirst = () => {
                setAnimating(true);
                setResult(null);
                let count = 0;
                const max = 20;
                const interval = setInterval(() => {
                    setResult(players[count % players.length].name);
                    count++;
                    if (count > max) {
                        clearInterval(interval);
                        const winner = players[Math.floor(Math.random() * players.length)];
                        setResult(winner.name);
                        setAnimating(false);
                    }
                }, 100);
            };

            const rollDice = (sides) => {
                setAnimating(true);
                setResult(null);
                setTimeout(() => {
                    setResult(Math.floor(Math.random() * sides) + 1);
                    setAnimating(false);
                }, 600);
            };

            const flipCoin = () => {
                setAnimating(true);
                setResult(null);
                setTimeout(() => {
                    setResult(Math.random() > 0.5 ? "Heads" : "Tails");
                    setAnimating(false);
                }, 600);
            };

            return (
                <div className="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
                    <div className="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex border-b border-slate-700">
                            {['first', 'dice', 'coin'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => { setActiveTab(tab); setResult(null); }}
                                    className={`flex-1 p-3 text-sm font-bold capitalize transition-colors ${activeTab === tab ? 'bg-purple-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    {tab === 'first' ? 'Who First?' : tab}
                                </button>
                            ))}
                        </div>

                        <div className="p-8 flex flex-col items-center justify-center min-h-[200px]">
                            {activeTab === 'first' && (
                                <>
                                    <div className={`text-3xl font-bold mb-6 text-center break-words w-full ${animating ? 'text-slate-500' : 'text-white'}`}>
                                        {result || "?"}
                                    </div>
                                    <button onClick={spinForFirst} disabled={animating} className="bg-slate-700 hover:bg-slate-600 text-white px-6 py-2 rounded-full font-bold">
                                        Spin Randomizer
                                    </button>
                                </>
                            )}
                            {activeTab === 'dice' && (
                                <>
                                    <div className={`text-6xl font-black mb-8 ${animating ? 'animate-bounce text-slate-500' : 'text-purple-400'}`}>
                                        {result || <Icons.Dices className="w-16 h-16 opacity-20" />}
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => rollDice(6)} disabled={animating} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold">Roll D6</button>
                                        <button onClick={() => rollDice(20)} disabled={animating} className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold">Roll D20</button>
                                    </div>
                                </>
                            )}
                            {activeTab === 'coin' && (
                                <>
                                    <div className={`text-4xl font-bold mb-8 ${animating ? 'animate-spin-slow text-slate-500' : 'text-yellow-400'}`}>
                                        {result || "Flip Me"}
                                    </div>
                                    <button onClick={flipCoin} disabled={animating} className="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 px-6 py-2 rounded-full font-bold">
                                        Flip Coin
                                    </button>
                                </>
                            )}
                        </div>
                        <div className="p-3 bg-slate-800 border-t border-slate-700 flex justify-center">
                            <button onClick={onClose} className="text-slate-400 hover:text-white text-sm">Close Tools</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. History Log Modal (Unchanged)
        const HistoryModal = ({ log = [], onClose }) => (
            <div className="fixed inset-0 bg-black/90 z-[70] flex items-end md:items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
                <div className="bg-slate-900 w-full max-w-md h-[60vh] rounded-t-2xl md:rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                        <h3 className="font-bold text-white flex items-center gap-2"><Icons.Clock className="w-4 h-4" /> Game Log</h3>
                        <button onClick={onClose}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {log.length === 0 ? (
                            <div className="text-center text-slate-500 mt-10">No history yet.</div>
                        ) : (
                            [...log].reverse().map((entry, i) => (
                                <div key={i} className="text-sm border-l-2 border-purple-500 pl-3 py-1">
                                    <span className="text-xs text-slate-500 block">{new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                    <span className="text-slate-200">{entry.message}</span>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>
        );

        // 3. Card Detail View (Modal) (Unchanged)
        const CardDetailModal = ({ card, onClose }) => (
            <div className="fixed inset-0 bg-black/95 z-[60] flex items-center justify-center p-4 backdrop-blur-md animate-in fade-in" onClick={onClose}>
                <div className="relative max-w-lg w-full flex flex-col items-center" onClick={e => e.stopPropagation()}>
                    <img
                        src={card.fullImage || card.image}
                        alt={card.name}
                        className="w-full max-h-[70vh] object-contain rounded-xl shadow-2xl mb-6 border border-slate-700/50"
                    />
                    <div className="text-center text-white bg-slate-900/80 p-4 rounded-xl backdrop-blur-sm border border-slate-700 w-full">
                        <h2 className="text-2xl font-bold text-purple-300 mb-1">{card.name}</h2>
                        {card.artist && (
                            <div className="text-sm text-slate-300 font-medium flex items-center justify-center gap-2">
                                <span>Art by {card.artist}</span>
                            </div>
                        )}
                        <div className="text-xs text-slate-500 mt-2 tracking-widest uppercase">™ & © Wizards of the Coast</div>
                    </div>
                    <button
                        onClick={onClose}
                        className="absolute -top-12 right-0 md:-right-12 p-2 text-white/50 hover:text-white bg-white/10 hover:bg-white/20 rounded-full transition-all"
                    >
                        <Icons.X className="w-8 h-8" />
                    </button>
                </div>
            </div>
        );

        // 4. Unified Card Search (Updated for Partner)
        // 7. Auth Page
        const AuthPage = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message.replace('Firebase: ', ''));
                } finally {
                    setLoading(false);
                }
            };

            const handleGuest = async () => {
                setLoading(true);
                try {
                    await signInAnonymously(auth);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
                    <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full animate-in fade-in zoom-in-95">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-purple-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-purple-500/20">
                                <Icons.Shield className="text-white w-10 h-10" />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">Welcome Back</h1>
                            <p className="text-slate-400">Sign in to sync your stats and profile</p>
                        </div>

                        {error && <div className="bg-red-900/50 border border-red-500 text-red-200 p-3 rounded-lg mb-6 text-sm font-bold text-center">{error}</div>}

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                                <input type="email" required className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition-colors" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                                <input type="password" required className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition-colors" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            <button disabled={loading} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50">
                                {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
                            </button>
                        </form>

                        <div className="mt-6 text-center space-y-4">
                            <button onClick={() => setIsLogin(!isLogin)} className="text-slate-400 hover:text-white text-sm">
                                {isLogin ? "Don't have an account? Sign up" : "Already have an account? Sign in"}
                            </button>
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-700"></div></div>
                                <div className="relative flex justify-center text-xs uppercase"><span className="bg-slate-900 px-2 text-slate-500">Or continue as</span></div>
                            </div>
                            <button onClick={handleGuest} className="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-3 rounded-xl transition-all border border-slate-700">
                                Guest
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const UsernameSetup = ({ user, onComplete }) => {
            const [username, setUsername] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);

                const cleanName = username.trim();
                const cleanId = cleanName.toLowerCase();

                if (cleanName.length < 3) {
                    setError("Username must be at least 3 characters.");
                    setLoading(false);
                    return;
                }

                try {
                    await runTransaction(db, async (transaction) => {
                        const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', cleanId);
                        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);

                        const usernameDoc = await transaction.get(usernameRef);
                        if (usernameDoc.exists()) {
                            throw "Username is already taken.";
                        }

                        transaction.set(usernameRef, { uid: user.uid });
                        transaction.set(userRef, { displayName: cleanName, updatedAt: serverTimestamp() }, { merge: true });
                    });

                    // Update Auth Profile for consistency
                    if (auth.currentUser) {
                        // We can't actually import updateProfile here easily as it wasn't in original import list fully correctly?
                        // Wait, I added it in previous step.
                        await updateProfile(auth.currentUser, { displayName: cleanName });
                    }

                    onComplete(cleanName);
                } catch (e) {
                    console.error(e);
                    setError(typeof e === 'string' ? e : "Error setting username. Try again.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-950 flex items-center justify-center p-4 z-50">
                    <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full animate-in fade-in zoom-in-95">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-purple-600 rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-purple-500/20">
                                <Icons.User className="text-white w-10 h-10" />
                            </div>
                            <h1 className="text-3xl font-bold text-white mb-2">Choose a Username</h1>
                            <p className="text-slate-400">This will be your unique identity in all games.</p>
                        </div>
                        {error && <div className="bg-red-900/50 border border-red-500 text-red-200 p-3 rounded-lg mb-6 text-sm font-bold text-center">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                                <input
                                    type="text"
                                    required
                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none transition-colors"
                                    value={username}
                                    onChange={e => setUsername(e.target.value)}
                                    placeholder="e.g. JaceBeleren"
                                />
                            </div>
                            <button disabled={loading} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50">
                                {loading ? 'Saving...' : 'Set Username'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const CardSearch = ({ onSelect, onClose, mode = 'commander', allowPartner = true }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [asPartner, setAsPartner] = useState(false);
            const debounceRef = useRef(null);

            const searchScryfall = async (q) => {
                if (!q || q.length < 3) {
                    setResults([]);
                    return;
                }
                setLoading(true);
                try {
                    let searchParams = `q=${encodeURIComponent(q + ' (game:paper)')}`;
                    if (mode === 'commander') {
                        searchParams = `q=${encodeURIComponent(q + ' (is:commander) (game:paper)')}`;
                    }

                    const response = await fetch(`https://api.scryfall.com/cards/search?${searchParams}`);
                    const data = await response.json();
                    if (data.data) {
                        setResults(data.data.slice(0, 20));
                    } else {
                        setResults([]);
                    }
                } catch (e) {
                    console.error(e);
                } finally {
                    setLoading(false);
                }
            };

            const handleInput = (e) => {
                const val = e.target.value;
                setQuery(val);
                clearTimeout(debounceRef.current);
                debounceRef.current = setTimeout(() => searchScryfall(val), 500);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b border-slate-700 flex flex-col gap-2">
                            <div className="flex items-center gap-3">
                                <Icons.Search className="text-slate-400 w-5 h-5" />
                                <input
                                    type="text"
                                    placeholder={mode === 'commander' ? "Search Commander..." : "Search Scryfall For Any Card.."}
                                    className="bg-transparent border-none outline-none text-white w-full placeholder:text-slate-500"
                                    value={query}
                                    onChange={handleInput}
                                    autoFocus
                                />
                                <button onClick={onClose}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button>
                            </div>
                            {mode === 'commander' && allowPartner && (
                                <label className="flex items-center gap-2 text-sm text-slate-300 cursor-pointer self-start ml-8">
                                    <input type="checkbox" checked={asPartner} onChange={e => setAsPartner(e.target.checked)} className="rounded border-slate-600 bg-slate-800 text-purple-600 focus:ring-purple-500" />
                                    <span>Add as Partner</span>
                                </label>
                            )}
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-2">
                            {loading && <div className="text-center text-slate-500 py-8">Searching Scryfall...</div>}
                            {!loading && results.length === 0 && query.length > 2 && <div className="text-center text-slate-500 py-8">No cards found.</div>}
                            {results.map((card) => (
                                <div
                                    key={card.id}
                                    onClick={() => onSelect({
                                        name: card.name,
                                        image: card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop || '',
                                        fullImage: card.image_uris?.large || card.card_faces?.[0]?.image_uris?.large || '',
                                        artist: card.artist || card.card_faces?.[0]?.artist || 'Unknown'
                                    }, asPartner)}
                                    className="flex items-center gap-4 p-2 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors group"
                                >
                                    <div className="w-12 h-12 rounded-full overflow-hidden bg-slate-800 shrink-0 border border-slate-700 group-hover:border-purple-500">
                                        {(card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop) ? (
                                            <img src={card.image_uris?.art_crop || card.card_faces?.[0]?.image_uris?.art_crop} alt={card.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="w-full h-full flex items-center justify-center text-xs text-slate-600">?</div>
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="text-sm font-medium text-slate-200 group-hover:text-purple-400 truncate">{card.name}</div>
                                        <div className="text-xs text-slate-500 truncate">{card.type_line}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Stats Page
        const StatsPage = ({ user }) => {
            const [stats, setStats] = useState({ topCommanders: [], topCommander: null, deathStats: null, leaderboard: [] });
            const [loading, setLoading] = useState(true);
            const [showExportModal, setShowExportModal] = useState(false);
            const [userProfile, setUserProfile] = useState(null);

            useEffect(() => {
                if (!user) return;

                // Existing Lookups
                const commandersRef = collection(db, 'artifacts', appId, 'public', 'data', 'commander_stats');
                const unsubscribeCommanders = onSnapshot(commandersRef, (snapshot) => {
                    const commanders = [];
                    snapshot.forEach(doc => commanders.push(doc.data()));
                    const sortedCommanders = commanders.sort((a, b) => (b.count || 0) - (a.count || 0)).slice(0, 5);

                    setStats(prev => ({
                        ...prev,
                        topCommanders: sortedCommanders,
                        topCommander: sortedCommanders.length > 0 ? sortedCommanders[0] : null
                    }));
                });

                const deathStatsRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_stats', 'deaths');
                const unsubscribeDeaths = onSnapshot(deathStatsRef, (docSnap) => {
                    setStats(prev => ({ ...prev, deathStats: docSnap.data() }));
                });

                // Leaderboard Lookup
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const q = query(usersRef, orderBy('stats.gamesPlayed', 'desc'), limit(3));
                const unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                    const leaders = [];
                    snapshot.forEach(doc => leaders.push({ id: doc.id, ...doc.data() }));
                    setStats(prev => ({ ...prev, leaderboard: leaders }));
                    if (loading) setLoading(false);
                });

                return () => { unsubscribeCommanders(); unsubscribeDeaths(); unsubscribeLeaderboard(); };
            }, [user]);

            if (loading) return <div className="flex items-center justify-center h-full text-slate-500">Loading Stats...</div>;

            return (
                <div className="absolute inset-0 p-8 overflow-y-auto scroll-container pb-24">
                    <div className="max-w-4xl mx-auto space-y-8">
                        <div className="flex items-center justify-between">
                            <h1 className="text-3xl font-bold text-white mb-2 flex items-center gap-3"><Icons.BarChart2 className="w-8 h-8 text-purple-500" /> Global Stats</h1>
                            <button onClick={() => setShowExportModal(true)} className="flex items-center gap-2 bg-purple-700/60 hover:bg-purple-600 text-white font-bold px-4 py-2 rounded-xl transition-colors border border-purple-500/50 text-sm">
                                <Icons.Share className="w-4 h-4" /> Export Card
                            </button>
                        </div>
                        {showExportModal && <StatsExportModal user={user} stats={stats} onClose={() => setShowExportModal(false)} />}

                        {/* Leaderboard */}
                        <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm">
                            <h2 className="text-xl font-bold text-white mb-6 flex items-center gap-2"><Icons.Crown className="w-5 h-5 text-yellow-400" /> Most Dedicated Players</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {stats.leaderboard.map((player, i) => (
                                    <div key={player.id} className={`p-4 rounded-xl border flex items-center gap-4 relative overflow-hidden ${i === 0 ? 'bg-yellow-900/20 border-yellow-500/50' : i === 1 ? 'bg-slate-800 border-slate-600' : 'bg-slate-900 border-slate-700'}`}>
                                        <div className={`text-4xl font-black opacity-20 absolute right-2 top-0 pointer-events-none ${i === 0 ? 'text-yellow-500' : 'text-slate-500'}`}>#{i + 1}</div>
                                        <div className="w-12 h-12 rounded-full border border-slate-600 bg-slate-800 flex items-center justify-center shrink-0">
                                            {player.favoriteCommander ? <img src={player.favoriteCommander.image} className="w-full h-full rounded-full object-cover" /> : <Icons.User className="w-6 h-6 text-slate-500" />}
                                        </div>
                                        <div>
                                            <div className="font-bold text-white truncate max-w-[150px]">{player.displayName || 'Anonymous'}</div>
                                            <div className="text-xs text-slate-400 font-bold uppercase">{player.stats?.gamesPlayed || 0} Games</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Top Commanders (Existing) */}
                        {stats.deathStats && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center">
                                    <Icons.Skull className="w-6 h-6 text-red-500 mb-2" />
                                    <div className="text-2xl font-bold text-white">{stats.deathStats.standard || 0}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider">Combat/Life</div>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center">
                                    <Icons.Sword className="w-6 h-6 text-orange-500 mb-2" />
                                    <div className="text-2xl font-bold text-white">{stats.deathStats.commander || 0}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider">Commander Dmg</div>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center">
                                    <Icons.Droplet className="w-6 h-6 text-green-500 mb-2" />
                                    <div className="text-2xl font-bold text-white">{stats.deathStats.poison || 0}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider">Poison</div>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center">
                                    <Icons.Book className="w-6 h-6 text-blue-500 mb-2" />
                                    <div className="text-2xl font-bold text-white">{stats.deathStats.milled || 0}</div>
                                    <div className="text-xs text-slate-500 uppercase tracking-wider">Milled Out</div>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                            <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-700/50 backdrop-blur-sm">
                                <h2 className="text-xl font-semibold text-purple-300 mb-6 flex items-center justify-between">
                                    <span>Top 5 Commanders</span>
                                    <span className="text-xs font-normal text-slate-500 bg-slate-800 px-2 py-1 rounded-full">All Time</span>
                                </h2>
                                <div className="space-y-4">
                                    {stats.topCommanders.length === 0 ? (
                                        <div className="text-slate-500 text-center py-10">No stats recorded yet. Play a game!</div>
                                    ) : (
                                        stats.topCommanders.map((cmd, index) => (
                                            <div key={cmd.name} className="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl hover:bg-slate-800 transition-all border border-transparent hover:border-purple-500/30 group">
                                                <div className={`w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm ${index === 0 ? 'bg-yellow-500 text-black' : index === 1 ? 'bg-slate-400 text-black' : index === 2 ? 'bg-orange-700 text-white' : 'bg-slate-700 text-slate-400'}`}>{index + 1}</div>
                                                <div className="w-12 h-12 rounded-full overflow-hidden bg-black shrink-0">
                                                    <img src={cmd.image} alt={cmd.name} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" />
                                                </div>
                                                <div className="flex-1">
                                                    <div className="text-white font-medium truncate">{cmd.name}</div>
                                                    <div className="text-xs text-slate-400">{cmd.count} plays</div>
                                                </div>
                                                {index === 0 && <Icons.Crown className="w-5 h-5 text-yellow-500" />}
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                            <div className="relative group rounded-2xl overflow-hidden shadow-2xl border-4 border-slate-900 min-h-[400px] flex items-center justify-center bg-slate-900">
                                {stats.topCommander ? (
                                    <>
                                        <img src={stats.topCommander.image} alt={stats.topCommander.name} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-90"></div>
                                        <div className="absolute bottom-0 left-0 right-0 p-8">
                                            <div className="flex items-center gap-2 text-yellow-500 mb-2 font-bold tracking-wider text-sm uppercase">
                                                <Icons.Crown className="w-4 h-4" />
                                                Most Popular Commander
                                            </div>
                                            <h2 className="text-4xl md:text-5xl font-black text-white leading-tight drop-shadow-lg">{stats.topCommander.name}</h2>
                                            <div className="mt-4 inline-flex items-center gap-2 bg-purple-600/90 text-white px-4 py-2 rounded-full backdrop-blur-md font-medium shadow-lg">
                                                {stats.topCommander.count} Total Picks
                                            </div>
                                        </div>
                                        {stats.topCommander.artist && (
                                            <div className="absolute bottom-2 right-2 text-[10px] text-white/40 font-medium text-right leading-tight z-10">
                                                <div>Art by {stats.topCommander.artist}</div>
                                                <div>™ & © Wizards of the Coast</div>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="flex flex-col items-center justify-center text-slate-600 gap-4">
                                        <Icons.Shield className="w-20 h-20 opacity-20" />
                                        <p>Play games to reveal the top commander!</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Player Card (Updated for Partner & Kick)
        const PlayerCard = ({ id, name, life, commander, partner, color, poison = 0, commanderDamage = {}, milled = false, mulligans = 0, lifeHistory = [], onUpdate, onDead, isDead, isLocal, isWinner, players = [], onLog, canKick, onKick, playerId, startLife = 40, ...props }) => {
            const [showCmdrSearch, setShowCmdrSearch] = useState(false);
            const [showTools, setShowTools] = useState(false);
            const [rotation, setRotation] = useState(0);
            const [activeTooltip, setActiveTooltip] = useState(null);
            const [confirmKick, setConfirmKick] = useState(false);
            const [showKick, setShowKick] = useState(false);
            const [showLifeGraph, setShowLifeGraph] = useState(false);

            const pushToLog = (msg) => { if (onLog) onLog(msg); };
            const lifeChangeRef = useRef(0);
            const lifeTimeoutRef = useRef(null);

            const adjustLife = (amount) => {
                const newLife = life + amount;
                const deadByPoison = poison >= 10;
                const deadByCmdr = Object.values(commanderDamage).some(d => d >= 21);
                const deadByLife = newLife <= 0;
                const newHistory = [...(lifeHistory || []), { life: newLife, change: amount, ts: Date.now() }].slice(-30);
                onUpdate(id, { life: newLife, isDead: deadByPoison || deadByCmdr || deadByLife || milled, lifeHistory: newHistory });
                lifeChangeRef.current += amount;
                if (lifeTimeoutRef.current) clearTimeout(lifeTimeoutRef.current);
                lifeTimeoutRef.current = setTimeout(() => {
                    if (lifeChangeRef.current !== 0) {
                        const val = lifeChangeRef.current;
                        pushToLog(`${name}: Life ${val > 0 ? '+' : ''}${val} (${newLife})`);
                        lifeChangeRef.current = 0;
                    }
                }, 1000);
            };

            const adjustPoison = (amount) => {
                const newPoison = Math.max(0, (poison || 0) + amount);
                const deadByPoison = newPoison >= 10;
                const deadByCmdr = Object.values(commanderDamage).some(dmg => dmg >= 21);
                const deadByLife = life <= 0;
                onUpdate(id, { poison: newPoison, isDead: deadByPoison || deadByCmdr || deadByLife || milled });
                pushToLog(`${name}: Poison ${amount > 0 ? '+' : ''}${amount} (${newPoison})`);
            };

            const toggleMilled = () => {
                const isNowMilled = !milled;
                const deadByPoison = poison >= 10;
                const deadByCmdr = Object.values(commanderDamage).some(dmg => dmg >= 21);
                const deadByLife = life <= 0;
                onUpdate(id, { milled: isNowMilled, isDead: deadByPoison || deadByCmdr || deadByLife || isNowMilled });
                pushToLog(`${name}: ${isNowMilled ? 'Milled Out' : 'Recovered from Mill'}`);
            };

            const adjustMulligans = (amt) => {
                const newCount = Math.max(0, (mulligans || 0) + amt);
                onUpdate(id, { mulligans: newCount });
                if (amt > 0) pushToLog(`${name}: Took mulligan #${newCount}`);
            };

            // key can be just opponentId (main) or opponentId-partner
            const adjustCmdrDamage = (key, amount, sourceName) => {
                const current = commanderDamage[key] || 0;
                const newDmg = Math.max(0, current + amount);
                const newMap = { ...commanderDamage, [key]: newDmg };
                const deadByPoison = poison >= 10;
                const deadByCmdr = Object.values(newMap).some(dmg => dmg >= 21);
                const deadByLife = life <= 0;
                onUpdate(id, { commanderDamage: newMap, isDead: deadByPoison || deadByCmdr || deadByLife || milled });
                pushToLog(`${name}: Cmdr Dmg from ${sourceName} ${amount > 0 ? '+' : ''}${amount} (${newDmg})`);
            };

            const toggleRotation = () => { setRotation(prev => (prev + 90) % 360); };
            const rotateClass = `rotate-${rotation}`;
            const isSideways = rotation === 90 || rotation === 270;
            const cardClasses = isWinner
                ? `relative flex flex-col h-full rounded-2xl overflow-hidden transition-all duration-300 bg-slate-900 border-2 border-yellow-400 winner-glow min-h-[250px]`
                : `relative flex flex-col h-full rounded-2xl overflow-hidden transition-all duration-300 ${isDead ? 'opacity-50 grayscale' : ''} ${color} min-h-[250px]`;

            return (
                <div className={cardClasses}>
                    {commander?.image && (<div className="absolute inset-0 z-0"><img src={commander.image} alt="bg" className="w-full h-full object-cover opacity-30 mix-blend-overlay" /><div className="absolute inset-0 bg-gradient-to-b from-black/20 via-transparent to-black/80" /></div>)}
                    {isLocal && !showTools && !showCmdrSearch && (<div className="absolute top-4 right-4 z-50"><button onClick={toggleRotation} className="p-2 bg-black/40 hover:bg-black/60 rounded-full text-white/90 transition-colors shadow-lg border border-white/10"><Icons.RotateCcw className="w-4 h-4" /></button></div>)}
                    <div className={`relative z-10 flex flex-col h-full p-4 transition-transform duration-300 ${rotateClass} ${isSideways ? 'scale-90 justify-center gap-2' : ''}`}>
                        <div className={`flex justify-between items-start ${isSideways ? 'w-full' : ''}`}>
                            <div className="flex flex-col items-start gap-1 max-w-[70%]">
                                <div className="flex items-center gap-2">
                                    <span onClick={() => { if (window.setViewProfile) window.setViewProfile(name); }} className={`font-bold text-sm bg-black/40 px-3 py-1 rounded-full backdrop-blur-md cursor-pointer hover:bg-black/60 hover:text-purple-300 transition-colors ${!props.isGuest && !isLocal ? 'text-green-400' : 'text-white'}`}>{name}</span>
                                    {canKick && showKick && (
                                        <button onClick={() => onKick(id)} className="text-red-500/50 hover:text-red-500 transition-colors p-1"><Icons.LogOut className="w-3 h-3" /></button>
                                    )}
                                </div>
                                <button onClick={() => setShowCmdrSearch(true)} className="flex items-center gap-2 bg-black/20 hover:bg-black/40 px-3 py-1.5 rounded-full backdrop-blur-md transition-colors text-white group max-w-full">
                                    <div className="flex flex-col items-start truncate">
                                        {commander?.name ? (<span className="font-semibold text-sm truncate w-full">{commander.name}</span>) : (<span className="flex items-center gap-1 text-xs uppercase tracking-wide font-bold opacity-80"><Icons.Search className="w-3 h-3" /> Commander</span>)}
                                        {partner?.name && <span className="text-[10px] text-purple-300 truncate w-full">+ {partner.name}</span>}
                                    </div>
                                </button>
                            </div>
                            <div className="flex items-center gap-2">{isLocal && <div className="w-8 h-8"></div>}{milled && <Icons.Book className="text-blue-400 w-5 h-5 drop-shadow-md" />}{isDead && <Icons.Skull className="text-red-500 w-6 h-6 animate-pulse" />}{isWinner && <Icons.Crown className="text-yellow-400 w-6 h-6 animate-bounce" />}</div>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center py-4">
                            <div className="flex items-center gap-6">
                                <button onClick={() => adjustLife(-1)} className="w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-sm active:scale-95 transition-all"><span className="text-3xl font-light mb-1">-</span></button>
                                <div className="flex flex-col items-center">
                                    <div className="text-7xl font-black text-white tabular-nums tracking-tighter drop-shadow-2xl relative">{life}{isWinner && <Icons.Crown className="w-8 h-8 text-yellow-400 absolute -top-8 -right-4 rotate-12 drop-shadow-lg" />}</div>
                                    <div className="flex gap-2">{(poison > 0) && (<div className="flex items-center gap-1 text-green-400 font-bold mt-1 bg-black/50 px-2 py-0.5 rounded-full text-xs"><Icons.Droplet className="w-3 h-3" /> {poison}/10</div>)}{milled && (<div className="flex items-center gap-1 text-blue-400 font-bold mt-1 bg-black/50 px-2 py-0.5 rounded-full text-xs border border-blue-500/50"><Icons.Book className="w-3 h-3" /> Milled</div>)}{mulligans > 0 && (<div className="flex items-center gap-1 text-yellow-300 font-bold mt-1 bg-black/50 px-2 py-0.5 rounded-full text-xs border border-yellow-500/30">🃏 {mulligans}×</div>)}</div>

                                    <div className="flex flex-wrap justify-center gap-1 mt-1 max-w-[120px] relative">
                                        {Object.entries(commanderDamage).map(([key, dmg]) => {
                                            if (dmg <= 0) return null;
                                            // Key is either opponentId or opponentId-partner
                                            const isPartnerDmg = key.includes('-partner');
                                            const sourceId = isPartnerDmg ? key.replace('-partner', '') : key;
                                            const sourcePlayer = players.find(p => p.id == sourceId);

                                            let tooltipText = `${sourcePlayer?.name || 'Unknown'}`;
                                            if (isPartnerDmg && sourcePlayer?.partner) tooltipText = `${sourcePlayer.partner.name} (${sourcePlayer.name})`;
                                            else if (!isPartnerDmg && sourcePlayer?.commander) tooltipText = `${sourcePlayer.commander.name} (${sourcePlayer.name})`;

                                            return (
                                                <div
                                                    key={key}
                                                    className="relative"
                                                    onMouseEnter={() => setActiveTooltip(key)}
                                                    onMouseLeave={() => setActiveTooltip(null)}
                                                    onClick={(e) => { e.stopPropagation(); setActiveTooltip(activeTooltip === key ? null : key); }}
                                                >
                                                    <div className={`flex items-center gap-1 font-bold bg-black/50 px-2 py-0.5 rounded-full text-xs cursor-pointer border
                                                        ${dmg >= 21
                                                            ? 'text-red-400 border-red-500/60 cmd-lethal'
                                                            : dmg >= 16
                                                                ? 'text-amber-400 border-amber-400/60 cmd-warning'
                                                                : isPartnerDmg ? 'text-orange-400 border-orange-500/20' : 'text-red-400 border-red-500/20'
                                                        }`}>
                                                        {dmg >= 16 ? <Icons.AlertTriangle className="w-3 h-3" /> : <Icons.Sword className="w-3 h-3" />} {dmg}/21
                                                    </div>
                                                    {/* Custom Tooltip Popover */}
                                                    {activeTooltip === key && (
                                                        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-32 bg-black text-white text-xs p-2 rounded-lg shadow-xl border border-red-500/50 z-50 text-center pointer-events-none animate-in fade-in zoom-in-95">
                                                            <div className="font-bold text-red-300 mb-1">{isPartnerDmg ? 'Partner Damage' : 'Commander Damage'}</div>
                                                            <div>{tooltipText}</div>
                                                            <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-black border-b border-r border-red-500/50 transform rotate-45"></div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <button onClick={() => adjustLife(1)} className="w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full text-white backdrop-blur-sm active:scale-95 transition-all"><span className="text-3xl font-light mb-1">+</span></button>
                            </div>
                        </div>
                        <div className="flex flex-col items-center space-y-3 relative">
                            <div className="flex justify-center gap-3">{[-10, -5, 5, 10].map(amt => (<button key={amt} onClick={() => adjustLife(amt)} className="px-3 py-1 bg-black/20 hover:bg-black/40 rounded-lg text-white/80 text-xs font-bold backdrop-blur-sm">{amt > 0 ? '+' : ''}{amt}</button>))}</div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowTools(true)} className="flex items-center gap-1 text-xs bg-slate-700/80 hover:bg-slate-600/80 text-white font-bold px-3 py-2 rounded-xl backdrop-blur-md transition-colors shadow-md"><Icons.Sliders className="w-4 h-4" /> Counters</button>
                                {(lifeHistory && lifeHistory.length > 0) && (
                                    <button onClick={() => setShowLifeGraph(true)} className="text-xs bg-purple-700/60 hover:bg-purple-600/80 text-white font-bold px-2 py-2 rounded-xl backdrop-blur-md transition-colors shadow-md" title="Life History"><Icons.BarChart2 className="w-4 h-4" /></button>
                                )}
                            </div>
                        </div>
                        {commander?.artist && (<div className="absolute bottom-1 right-2 text-[10px] text-white/40 font-medium pointer-events-none text-right leading-tight"><div>Art by {commander.artist}</div><div>™ & © Wizards of the Coast</div></div>)}
                    </div>
                    {showCmdrSearch && <CardSearch
                        onSelect={(c, asPartner) => {
                            if (asPartner) onUpdate(id, { partner: c });
                            else onUpdate(id, { commander: c });
                            if (onLog) onLog(`${name} chose ${asPartner ? 'Partner ' + c.name : c.name}`);
                            setShowCmdrSearch(false);
                        }}
                        onClose={() => setShowCmdrSearch(false)}
                        mode="commander"
                    />}
                    {showLifeGraph && <LifeHistoryModal name={name} history={lifeHistory || []} startLife={startLife} onClose={() => setShowLifeGraph(false)} />}
                    {showTools && (
                        <div className={`absolute inset-0 bg-slate-900/95 z-20 flex flex-col p-4 transition-transform duration-300 ${rotateClass}`}>
                            <div className="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h3 className="text-white font-bold flex items-center gap-2"><Icons.Sliders className="w-4 h-4" /> Damage & Counters</h3><button onClick={() => setShowTools(false)}><Icons.X className="w-5 h-5 text-slate-400 hover:text-white" /></button></div>
                            <div className="flex-1 overflow-y-auto space-y-4">
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div className="flex justify-between items-center mb-2"><span className="text-sm font-semibold text-green-400 flex items-center gap-2"><Icons.Droplet className="w-4 h-4" /> Poison (Infect)</span><span className="text-xs text-slate-500">Die at 10</span></div><div className="flex items-center justify-between bg-slate-900 rounded-lg p-2"><button onClick={() => adjustPoison(-1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button><span className="font-mono text-xl text-white font-bold">{poison || 0}</span><button onClick={() => adjustPoison(1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">+</button></div></div>

                                {/* Mulligan Tracker */}
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-yellow-900/40">
                                    <div className="flex justify-between items-center mb-2">
                                        <span className="text-sm font-semibold text-yellow-300 flex items-center gap-2">🃏 Mulligans</span>
                                        <span className="text-xs text-slate-500">Tracking only</span>
                                    </div>
                                    <div className="flex items-center justify-between bg-slate-900 rounded-lg p-2">
                                        <button onClick={() => adjustMulligans(-1)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button>
                                        <span className="font-mono text-xl text-white font-bold">{mulligans || 0}</span>
                                        <button onClick={() => adjustMulligans(1)} className="w-8 h-8 flex items-center justify-center bg-yellow-700/80 rounded text-white hover:bg-yellow-600">+</button>
                                    </div>
                                </div>

                                {/* Milled */}
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><span className="text-sm font-semibold text-blue-400 flex items-center gap-2 mb-2"><Icons.Book className="w-4 h-4" /> Library Status</span><button onClick={toggleMilled} className={`w-full py-2 rounded-lg font-bold text-sm transition-all ${milled ? 'bg-blue-600 text-white' : 'bg-slate-900 text-slate-400 hover:bg-slate-800'}`}>{milled ? '📚 Milled Out' : 'Mark as Milled Out'}</button></div>

                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div className="flex justify-between items-center mb-2"><span className="text-sm font-semibold text-red-400 flex items-center gap-2"><Icons.Sword className="w-4 h-4" /> Commander Damage</span><span className="text-xs text-slate-500">Die at 21 per Cmdr</span></div><div className="space-y-2">
                                    {[...players].filter(p => p.id !== id).sort((a, b) => String(a.id).localeCompare(String(b.id))).map(opponent => {
                                        const dmgMain = commanderDamage[opponent.id] || 0;
                                        const dmgPartner = commanderDamage[`${opponent.id}-partner`] || 0;

                                        return (
                                            <div key={opponent.id} className="flex flex-col gap-2 bg-slate-900 rounded-lg p-2">
                                                {/* Main Commander */}
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2 overflow-hidden mr-2">
                                                        <div className={`w-2 h-8 rounded-full ${opponent.id === id ? 'bg-purple-500' : 'bg-slate-600'}`}></div>
                                                        <div className="flex flex-col truncate">
                                                            <span className="text-xs font-bold text-white truncate">{opponent.commander?.name || opponent.name}</span>
                                                            <span className="text-[10px] text-slate-500 uppercase">From {opponent.name}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3 shrink-0">
                                                        <button onClick={() => adjustCmdrDamage(opponent.id, -1, opponent.commander?.name || opponent.name)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button>
                                                        <span className={`font-mono text-lg font-bold w-6 text-center ${dmgMain >= 21 ? 'text-red-500' : 'text-white'}`}>{dmgMain}</span>
                                                        <button onClick={() => adjustCmdrDamage(opponent.id, 1, opponent.commander?.name || opponent.name)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">+</button>
                                                    </div>
                                                </div>

                                                {/* Partner Commander (if exists) */}
                                                {opponent.partner && (
                                                    <div className="flex items-center justify-between border-t border-slate-800 pt-2">
                                                        <div className="flex items-center gap-2 overflow-hidden mr-2">
                                                            <div className="w-2 h-8 rounded-full bg-orange-500/50"></div>
                                                            <div className="flex flex-col truncate">
                                                                <span className="text-xs font-bold text-orange-200 truncate">{opponent.partner.name}</span>
                                                                <span className="text-[10px] text-slate-500 uppercase">Partner</span>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-3 shrink-0">
                                                            <button onClick={() => adjustCmdrDamage(`${opponent.id}-partner`, -1, opponent.partner.name)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">-</button>
                                                            <span className={`font-mono text-lg font-bold w-6 text-center ${dmgPartner >= 21 ? 'text-red-500' : 'text-white'}`}>{dmgPartner}</span>
                                                            <button onClick={() => adjustCmdrDamage(`${opponent.id}-partner`, 1, opponent.partner.name)} className="w-8 h-8 flex items-center justify-center bg-slate-700 rounded text-white hover:bg-slate-600">+</button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div></div>

                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700"><div className="flex justify-between items-center mb-2"><span className="text-sm font-semibold text-blue-400 flex items-center gap-2"><Icons.Book className="w-4 h-4" /> Library (Mill)</span><span className="text-xs text-slate-500">Die if Milled</span></div><div className="flex items-center justify-between bg-slate-900 rounded-lg p-2"><span className="text-sm text-slate-300 ml-2">Milled Out?</span><button onClick={toggleMilled} className={`px-4 py-2 rounded-lg font-bold transition-colors ${milled ? 'bg-red-600 text-white hover:bg-red-500' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>{milled ? "YES (Dead)" : "NO"}</button></div></div>

                                {/* KICK PLAYER BUTTON FOR HOST */}
                                {canKick && (
                                    <div className="mt-4 pt-4 border-t border-slate-700">
                                        <button
                                            onClick={() => { if (confirmKick) onKick(id); else setConfirmKick(true); }}
                                            className={`w-full py-3 rounded-lg font-bold transition-colors flex items-center justify-center gap-2 ${confirmKick ? 'bg-red-600 text-white animate-pulse' : 'bg-red-900/50 border border-red-700 text-red-200 hover:bg-red-800'}`}
                                            onMouseLeave={() => setConfirmKick(false)}
                                        >
                                            <Icons.LogOut className="w-4 h-4" />
                                            {confirmKick ? "Confirm Kick?" : "Kick Player"}
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 7. Contact Page (Unchanged)
        const ContactPage = () => (
            <div className="absolute inset-0 flex flex-col items-center justify-center p-8 text-center animate-in fade-in duration-500 scroll-container overflow-y-auto pb-24">
                <div className="bg-slate-900/50 backdrop-blur-lg p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full">
                    <div className="w-16 h-16 bg-purple-600/20 rounded-full flex items-center justify-center mx-auto mb-6"><Icons.Mail className="w-8 h-8 text-purple-500" /></div>
                    <h1 className="text-3xl font-bold text-white mb-2">Get in Touch</h1>
                    <p className="text-slate-400 mb-8">Have feedback or feature requests? We'd love to hear from you.</p>
                    <a href="mailto:CardboardBonFire@gmail.com" className="block w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white font-medium py-4 px-6 rounded-xl transition-all hover:border-purple-500 group"><span className="text-xs text-slate-500 uppercase tracking-wider block mb-1 group-hover:text-purple-400">Email Us At</span><span className="text-lg break-all">CardboardBonFire@gmail.com</span></a>
                </div>
            </div>
        );

        // 8. Profile Page
        const ProfilePage = ({ user, viewProfileId = null, onBack = null }) => {
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [editing, setEditing] = useState(false);
            const [formData, setFormData] = useState({ displayName: '', favoriteColor: 'Colorless' });
            const [showCmdrSearch, setShowCmdrSearch] = useState(false);
            const [isFollowing, setIsFollowing] = useState(false);
            const [resolvedUid, setResolvedUid] = useState(null);
            const [notFound, setNotFound] = useState(false);
            const [showCopied, setShowCopied] = useState(false);

            useEffect(() => {
                const resolveAndLoad = async () => {
                    setLoading(true);
                    setNotFound(false);
                    let target = viewProfileId;

                    // If no ID passed, assume current user
                    if (!target) {
                        if (user) target = user.uid;
                        else { setLoading(false); return; }
                    }

                    // Check if target is a Username (heuristic: not 28 chars or contains spaces/etc - though firebase UIDs are restrictive)
                    // Safer: Check 'usernames' collection first if it doesn't look like a standard UID, OR just always check usernames if length != 28
                    if (target.length !== 28 && target !== user?.uid) {
                        try {
                            const usernameDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'usernames', target.toLowerCase()));
                            if (usernameDoc.exists()) {
                                target = usernameDoc.data().uid;
                            } else {
                                // Could be a legacy UID or invalid. If it fails `getUserProfile`, we show not found.
                            }
                        } catch (e) { console.error("Username lookup failed", e); }
                    }

                    setResolvedUid(target);

                    const data = await getUserProfile(target);
                    if (data) {
                        setProfile(data);
                        if (user && target === user.uid) {
                            setFormData({
                                displayName: data.displayName || '',
                                favoriteColor: data.favoriteColor || 'Colorless'
                            });
                        }
                        // Check follow status
                        if (user && target !== user.uid) {
                            const currentUserDoc = await getUserProfile(user.uid);
                            if (currentUserDoc && currentUserDoc.following && currentUserDoc.following.includes(target)) {
                                setIsFollowing(true);
                            }
                        }
                    } else {
                        setNotFound(true);
                    }
                    setLoading(false);
                };
                resolveAndLoad();
            }, [viewProfileId, user]);

            const isOwnProfile = user && resolvedUid === user.uid;
            const targetUid = resolvedUid;

            const handleSave = async () => {
                if (!user || !isOwnProfile) return;
                try {
                    await updateUserProfile(user.uid, formData);
                    setProfile({ ...profile, ...formData });
                    setEditing(false);
                    if (formData.displayName) localStorage.setItem('mtg_username', formData.displayName);
                } catch (e) {
                    console.error("Save failed", e);
                }
            };

            const handleLogout = async () => {
                try { await signOut(auth); } catch (e) { console.error(e); }
            };

            const toggleFollow = async () => {
                if (!user || isOwnProfile) return;
                try {
                    if (isFollowing) {
                        await unfollowUser(user.uid, targetUid);
                        setIsFollowing(false);
                        setProfile(prev => ({ ...prev, followers: (prev.followers || []).filter(id => id !== user.uid) }));
                    } else {
                        await followUser(user.uid, targetUid);
                        setIsFollowing(true);
                        setProfile(prev => ({ ...prev, followers: [...(prev.followers || []), user.uid] }));
                    }
                } catch (e) {
                    console.error(e);
                }
            };

            const updateCommander = async (card) => {
                const newProfile = { ...formData, favoriteCommander: card };
                setFormData(newProfile);
                if (!editing) {
                    await updateUserProfile(user.uid, { favoriteCommander: card });
                    setProfile(prev => ({ ...prev, favoriteCommander: card }));
                }
            };

            if (loading) return <div className="flex items-center justify-center h-full text-slate-500">Loading Profile...</div>;

            return (
                <div className="absolute inset-0 p-8 overflow-y-auto scroll-container pb-24">
                    <div className="max-w-2xl mx-auto space-y-8">
                        {onBack && <button onClick={onBack} className="text-slate-400 hover:text-white flex items-center gap-1 mb-4"><Icons.ChevronLeft className="w-4 h-4" /> Back</button>}
                        <div className="flex items-center justify-between">
                            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
                                <Icons.User className="w-8 h-8 text-purple-500" />
                                {isOwnProfile ? 'My Profile' : (profile?.displayName || 'Player Profile')}
                            </h1>
                            <div className="flex gap-2">
                                {isOwnProfile ? (
                                    <>
                                        <button onClick={() => {
                                            const url = window.location.origin + window.location.pathname + '?profile=' + (profile.displayName || user.uid);
                                            navigator.clipboard.writeText(url);
                                            setShowCopied(true);
                                            setTimeout(() => setShowCopied(false), 2000);
                                        }} className="bg-purple-900/30 hover:bg-purple-900/50 text-purple-200 px-4 py-2 rounded-lg font-bold transition-colors border border-purple-900/50 flex items-center gap-2">
                                            <Icons.Share className="w-5 h-5" />
                                            {showCopied ? 'Copied!' : 'Share'}
                                        </button>
                                        <button onClick={() => setEditing(!editing)} className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-bold transition-colors border border-slate-700">
                                            {editing ? 'Cancel' : 'Edit Profile'}
                                        </button>
                                        <button onClick={handleLogout} className="bg-red-900/30 hover:bg-red-900/50 text-red-200 px-4 py-2 rounded-lg font-bold transition-colors border border-red-900/50">
                                            <Icons.LogOut className="w-5 h-5" />
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={toggleFollow} className={`px-6 py-2 rounded-lg font-bold transition-all border ${isFollowing ? 'bg-transparent border-slate-500 text-slate-400 hover:border-red-500 hover:text-red-500' : 'bg-purple-600 border-purple-500 text-white hover:bg-purple-500'}`}>
                                        {isFollowing ? 'Unfollow' : 'Follow'}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Social Counts */}
                        <div className="flex gap-6 justify-center md:justify-start">
                            <div className="text-center md:text-left"><span className="text-2xl font-black text-white">{profile?.followers?.length || 0}</span> <span className="text-xs text-slate-500 uppercase font-bold">Followers</span></div>
                            <div className="text-center md:text-left"><span className="text-2xl font-black text-white">{profile?.following?.length || 0}</span> <span className="text-xs text-slate-500 uppercase font-bold">Following</span></div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            {/* Stats Card */}
                            <div className="md:col-span-3 bg-slate-900/50 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm">
                                <h2 className="text-xl font-bold text-white mb-4">Lifetime Stats</h2>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-slate-950 p-4 rounded-xl text-center">
                                        <div className="text-3xl font-black text-white">{profile?.stats?.gamesPlayed || 0}</div>
                                        <div className="text-xs text-slate-500 uppercase font-bold">Games Played</div>
                                    </div>
                                    <div className="bg-slate-950 p-4 rounded-xl text-center">
                                        <div className="text-3xl font-black text-purple-400">{profile?.stats?.wins || 0}</div>
                                        <div className="text-xs text-slate-500 uppercase font-bold">Wins</div>
                                    </div>
                                    <div className="bg-slate-950 p-4 rounded-xl text-center">
                                        <div className="text-3xl font-black text-green-400">{profile?.stats?.gamesPlayed ? Math.round(((profile.stats.wins || 0) / profile.stats.gamesPlayed) * 100) : 0}%</div>
                                        <div className="text-xs text-slate-500 uppercase font-bold">Win Rate</div>
                                    </div>
                                    <div className="bg-slate-950 p-4 rounded-xl text-center flex items-center justify-center flex-col">
                                        <IdentityIcon id={profile?.favoriteColor} />
                                        <div className="text-xs text-slate-500 uppercase font-bold mt-2">{profile?.favoriteColor || 'Colorless'}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Edit Form */}
                            <div className="md:col-span-2 space-y-6">
                                <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm">
                                    <h2 className="text-xl font-bold text-white mb-4">Player Details</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Display Name</label>
                                            {editing ? (
                                                <input
                                                    type="text"
                                                    value={formData.displayName}
                                                    onChange={e => setFormData({ ...formData, displayName: e.target.value })}
                                                    className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white focus:border-purple-500 outline-none"
                                                />
                                            ) : (
                                                <div className="text-lg font-bold text-white">{profile?.displayName || user.email || 'Anonymous'}</div>
                                            )}
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Color Identity</label>
                                            {editing ? (
                                                <div className="grid grid-cols-4 sm:grid-cols-6 gap-2 max-h-48 overflow-y-auto p-1">
                                                    {Object.keys(MTG_IDENTITIES).map(id => (
                                                        <button
                                                            key={id}
                                                            onClick={() => setFormData({ ...formData, favoriteColor: id })}
                                                            className={`p-2 rounded-lg border flex flex-col items-center gap-2 transition-all h-24 justify-center ${formData.favoriteColor === id ? 'bg-purple-600/20 border-purple-500 scale-105 shadow-lg shadow-purple-500/10' : 'border-transparent bg-slate-800/50 hover:bg-slate-800 hover:border-slate-600'}`}
                                                            title={id}
                                                        >
                                                            <IdentityIcon id={id} />
                                                            <span className="text-[10px] uppercase font-bold text-slate-400">{id}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="flex items-center gap-2">
                                                    <IdentityIcon id={profile?.favoriteColor} />
                                                    <span className="text-slate-300 font-bold">{profile?.favoriteColor || 'Colorless'}</span>
                                                    {MTG_IDENTITIES[profile?.favoriteColor]?.description && <span className="text-xs text-slate-500">({MTG_IDENTITIES[profile?.favoriteColor]?.description})</span>}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    {editing && (
                                        <button onClick={handleSave} className="mt-6 w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all">
                                            Save Changes
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Favorite Commander (Updated Logic) */}
                            <div className="md:col-span-1">
                                <div className="bg-slate-900/50 p-6 rounded-2xl border border-slate-700 backdrop-blur-sm h-full flex flex-col">
                                    <h2 className="text-xl font-bold text-white mb-4">Favorite Commander</h2>
                                    {(editing ? formData.favoriteCommander : profile?.favoriteCommander) ? (
                                        <div className="relative flex-1 rounded-xl overflow-hidden border border-slate-700 group cursor-pointer" onClick={() => editing && setShowCmdrSearch(true)}>
                                            <img src={(editing ? formData.favoriteCommander : profile.favoriteCommander)?.image} className="w-full h-full object-cover" alt="Commander" />
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end p-4">
                                                <div className="font-bold text-white">{(editing ? formData.favoriteCommander : profile.favoriteCommander)?.name}</div>
                                            </div>
                                            {editing && <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Search className="w-8 h-8 text-white" /></div>}
                                        </div>
                                    ) : (
                                        <button onClick={() => editing && setShowCmdrSearch(true)} className={`flex-1 rounded-xl border-2 border-dashed border-slate-700 flex flex-col items-center justify-center gap-2 text-slate-500 ${editing ? 'hover:border-purple-500 hover:text-purple-400 cursor-pointer' : ''}`}>
                                            <Icons.Sword className="w-8 h-8" />
                                            <span>No Commander Set</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    {showCmdrSearch && <CardSearch
                        onSelect={(card) => { updateCommander(card); setShowCmdrSearch(false); }}
                        onClose={() => setShowCmdrSearch(false)}
                        mode="commander"
                        allowPartner={false}
                    />}
                </div>
            );
        };

        // 8. Online Room (Refactored for Stability)
        const OnlineRoom = ({ user, onLeave }) => {
            const [joinedRoom, setJoinedRoom] = useState(null);
            const [error, setError] = useState('');
            const [players, setPlayers] = useState([]);
            const [roomData, setRoomData] = useState(null);
            const [showCopiedToast, setShowCopiedToast] = useState(false);
            const [showCardSearch, setShowCardSearch] = useState(false);
            const [viewingCard, setViewingCard] = useState(null);

            const [confirmReset, setConfirmReset] = useState(false);
            const [confirmClose, setConfirmClose] = useState(false);

            const [showChat, setShowChat] = useState(false);
            const [chatInput, setChatInput] = useState('');
            const [messages, setMessages] = useState([]);
            const [unreadCount, setUnreadCount] = useState(0);
            const lastMsgCountRef = useRef(0);
            const chatEndRef = useRef(null);

            // --- FIX 3: Ref to hold latest player state for Heartbeat closure ---
            const playersRef = useRef([]);

            // --- FIX 4: Ref to prevent "Click Twice" race condition ---
            const isJoiningRef = useRef(false);
            const lastWinnerRef = useRef(null); // Track processed winner to avoid duplicate stats
            const [showToolsModal, setShowToolsModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [roomLog, setRoomLog] = useState([]);

            const [rooms, setRooms] = useState([]);
            const [playerName, setPlayerName] = useState('');
            const [hostName, setHostName] = useState('');
            const [hostPassword, setHostPassword] = useState('');
            const [joinPassword, setJoinPassword] = useState('');
            const [selectedRoomId, setSelectedRoomId] = useState(null);



            const TIMEOUT_INACTIVITY = 20 * 60 * 1000;
            const TIMEOUT_DURATION = 12 * 60 * 60 * 1000;

            useEffect(() => { const storedName = localStorage.getItem('mtg_username'); if (storedName) setPlayerName(storedName); }, []);
            const updatePlayerName = (name) => { setPlayerName(name); localStorage.setItem('mtg_username', name); };
            const getMillis = (ts) => { if (!ts) return Date.now(); return ts.toMillis ? ts.toMillis() : Date.now(); };

            // Wake Lock
            useEffect(() => {
                let wakeLock = null;
                const requestWakeLock = async () => {
                    try {
                        if ('wakeLock' in navigator) {
                            wakeLock = await navigator.wakeLock.request('screen');
                        }
                    } catch (err) {
                        console.log(`${err.name}, ${err.message}`);
                    }
                };
                if (joinedRoom) {
                    requestWakeLock();
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                }
                async function handleVisibilityChange() {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                }
                return () => {
                    if (wakeLock !== null) {
                        wakeLock.release();
                        wakeLock = null;
                    }
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [joinedRoom]);

            // Room List
            useEffect(() => {
                if (joinedRoom) return;
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) setSelectedRoomId(roomParam);

                const roomsRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms');
                const unsub = onSnapshot(roomsRef, (snap) => {
                    const r = [];
                    const now = Date.now();
                    snap.forEach(d => {
                        const data = d.data();
                        const created = getMillis(data.createdAt);
                        const lastActive = getMillis(data.lastActivity);
                        if (now - lastActive < TIMEOUT_INACTIVITY && now - created < TIMEOUT_DURATION) {
                            // Adjust for Map or Array
                            const pCount = Array.isArray(data.players) ? data.players.length : Object.keys(data.players || {}).length;
                            r.push({ id: d.id, ...data, playerCount: pCount });
                        }
                    });
                    setRooms(r);
                });
                return () => unsub();
            }, [joinedRoom]);

            // --- FIX 1: Add Player Logic moved here ---
            const joinRoomLogic = async (roomName, password = null) => {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomName);

                try {
                    await runTransaction(db, async (transaction) => {
                        const roomDoc = await transaction.get(roomRef);
                        if (!roomDoc.exists()) { throw new Error("Room does not exist."); }

                        const data = roomDoc.data();
                        if (data.password && data.password !== password) { throw new Error("Incorrect Password"); }

                        let currentPlayers = data.players || {};
                        let isArray = Array.isArray(currentPlayers);

                        // Check presence
                        const existingPlayer = isArray
                            ? currentPlayers.find(p => p.id === user.uid)
                            : currentPlayers[user.uid];

                        if (!existingPlayer) {
                            const newPlayer = {
                                id: user.uid,
                                name: playerName || `Player ${Object.keys(currentPlayers).length + 1}`,
                                life: 40,
                                commander: null,
                                isDead: false,
                                poison: 0,
                                milled: false,
                                commanderDamage: {},
                                lastHeartbeat: Date.now(),
                                isGuest: user.isAnonymous
                            };

                            if (isArray) {
                                // MIGRATION: Convert Array to Map if we are the one joining and it's still an array
                                const map = {};
                                currentPlayers.forEach(p => map[p.id] = p);
                                map[user.uid] = newPlayer;
                                transaction.update(roomRef, {
                                    players: map,
                                    lastActivity: serverTimestamp()
                                });
                            } else {
                                // Atomic Update
                                transaction.update(roomRef, {
                                    [`players.${user.uid}`]: newPlayer,
                                    lastActivity: serverTimestamp()
                                });
                            }
                        }
                    });
                    // Mark as joining to prevent race condition kick
                    isJoiningRef.current = true;
                    setJoinedRoom(roomName);
                } catch (e) {
                    setError(e.message);
                    isJoiningRef.current = false;
                }
            };

            const createRoom = async () => {
                if (!hostName || !playerName) { setError("Room Name and Player Name are required."); return; }
                if (!user) { setError("Authenticating..."); return; }
                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', hostName);
                    const playerData = {
                        id: user.uid,
                        name: playerName,
                        life: 40,
                        commander: null,
                        partner: null,
                        isDead: false,
                        poison: 0,
                        commanderDamage: {},
                        milled: false,
                        lastActive: Date.now(),
                        lastHeartbeat: Date.now(),
                        isGuest: user.isAnonymous
                    };
                    await setDoc(roomRef, {
                        name: hostName, password: hostPassword, hostId: user.uid, createdAt: serverTimestamp(),
                        lastActivity: serverTimestamp(), players: { [user.uid]: playerData }, log: [], messages: []
                    });
                    if (playerData.commander && hostName !== "Test") updateCommanderStat(playerData.commander);
                    isJoiningRef.current = true;
                    setJoinedRoom(hostName);
                } catch (err) { setError(err.message); isJoiningRef.current = false; }
            };

            const joinRoom = () => {
                if (!selectedRoomId && !hostName) { setError("Select a room."); return; }
                const rName = selectedRoomId || hostName;
                if (!playerName) { setError("Enter Display Name."); return; }
                joinRoomLogic(rName, joinPassword);
            };

            const copyRoomLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(joinedRoom)}`;
                const el = document.createElement('textarea');
                el.value = url;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                setShowCopiedToast(true);
                setTimeout(() => setShowCopiedToast(false), 2000);
            };

            const closeRoom = async () => {
                if (!joinedRoom) return;
                await recordDeathStats(playersRef.current);
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom));
                    setJoinedRoom(null);
                    setConfirmClose(false);
                } catch (e) { setError(e.message); }
            };

            const resetGame = async () => {
                if (!joinedRoom) return;
                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                    // Use standard batch update logic with dot notation
                    const updates = {};
                    playersRef.current.forEach(p => {
                        updates[`players.${p.id}.life`] = 40;
                        updates[`players.${p.id}.poison`] = 0;
                        updates[`players.${p.id}.milled`] = false;
                        updates[`players.${p.id}.commanderDamage`] = {};
                        updates[`players.${p.id}.isDead`] = false;
                    });
                    updates.messages = arrayUnion({ sender: "System", text: "Game has been reset.", timestamp: Date.now() });

                    await updateDoc(roomRef, updates);
                    setConfirmReset(false);
                    lastWinnerRef.current = null; // Reset stat tracker
                } catch (e) { setError(e.message); }
            };

            const sendMessage = async (customText = null, cardData = null) => {
                const textToSend = customText || chatInput.trim();
                if (!textToSend) return;
                const msg = { sender: playerName, text: textToSend, timestamp: Date.now(), card: cardData };
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                await updateDoc(roomRef, { messages: arrayUnion(msg) });
                if (!customText) setChatInput('');
            };

            const addLogEntry = async (entry) => {
                if (!joinedRoom) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                await updateDoc(roomRef, { log: arrayUnion({ timestamp: Date.now(), message: entry }) });
            };

            const handleLeaveRoom = async () => {
                if (!joinedRoom || !user) return;
                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                    // Use ref to get latest state for leaving logic
                    const currentList = playersRef.current;
                    const remainingPlayers = currentList.filter(p => p.id !== user.uid);


                    // Atomic Leave
                    await updateDoc(roomRef, {
                        [`players.${user.uid}`]: deleteField()
                    });

                    // Check if room empty (this is best effort, strictly speaking we should use a transaction or cloud function to delete empty rooms, but this logic was client-side rely)
                    // We'll leave the room deletion to a separate cleanup or just let it exist empty until timeout.
                    // But to match previous logic:
                    if (remainingPlayers.length === 0) {
                        // We can try to delete it, but if we just left, we might not have permission if rules require being in it?
                        // Assuming open permissions for now as per previous code
                        await deleteDoc(roomRef);
                    }

                    setJoinedRoom(null);
                    onLeave();
                } catch (e) {
                    console.error("Error leaving room:", e);
                    setJoinedRoom(null);
                    onLeave();
                }
            };

            // NEW: Kick Player Function
            const handleKickPlayer = async (playerIdToKick) => {
                if (!joinedRoom || !isHost) return;
                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                    await updateDoc(roomRef, {
                        [`players.${playerIdToKick}`]: deleteField(),
                        messages: arrayUnion({ sender: "System", text: "A player was kicked from the room.", timestamp: Date.now() })
                    });
                } catch (e) {
                    console.error("Error kicking player:", e);
                }
            };

            // --- FIX 1 (Cont): Listener ONLY listens ---
            const ChatMessage = ({ msg, isMyMsg, onViewCard }) => {
                const [showTooltip, setShowTooltip] = useState(false);

                // If message has card data, we render differently
                if (msg.card) {
                    const parts = msg.text.split(`[${msg.card.name}]`);
                    if (parts.length === 2) {
                        return (
                            <div className={`flex flex-col ${isMyMsg ? 'items-end' : 'items-start'}`}>
                                <div className="text-[10px] text-slate-500 px-1 mb-0.5">{msg.sender}</div>
                                <div className={`px-3 py-2 rounded-lg text-sm max-w-[85%] break-words relative overflow-visible ${isMyMsg ? 'bg-purple-600 text-white rounded-br-none' : 'bg-slate-700 text-slate-200 rounded-bl-none'}`}>
                                    <span>{parts[0]}</span>
                                    <span
                                        className="font-bold underline decoration-dotted cursor-pointer relative inline-block text-purple-200 hover:text-white"
                                        onMouseEnter={() => setShowTooltip(true)}
                                        onMouseLeave={() => setShowTooltip(false)}
                                        onClick={(e) => { e.stopPropagation(); setShowTooltip(false); onViewCard(msg.card); }}
                                    >
                                        {msg.card.name}
                                        {showTooltip && (
                                            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 rounded-xl shadow-2xl border-2 border-slate-600/50 z-50 animate-in fade-in zoom-in-95 pointer-events-none bg-slate-900 overflow-hidden">
                                                <img src={msg.card.image} alt={msg.card.name} className="w-full h-auto object-cover" />
                                            </div>
                                        )}
                                    </span>
                                    <span>{parts[1]}</span>
                                </div>
                            </div>
                        );
                    }
                }

                return (
                    <div className={`flex flex-col ${isMyMsg ? 'items-end' : 'items-start'}`}>
                        <div className="text-[10px] text-slate-500 px-1 mb-0.5">{msg.sender}</div>
                        <div className={`px-3 py-2 rounded-lg text-sm max-w-[85%] break-words ${isMyMsg ? 'bg-purple-600 text-white rounded-br-none' : 'bg-slate-700 text-slate-200 rounded-bl-none'}`}>
                            {msg.text}
                        </div>
                    </div>
                );
            };

            useEffect(() => {
                if (!joinedRoom || !user) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setRoomData(data);

                        // Timeout checks
                        const now = Date.now();
                        const created = getMillis(data.createdAt);
                        const lastActive = getMillis(data.lastActivity);
                        if (now - lastActive > TIMEOUT_INACTIVITY) { setJoinedRoom(null); setError("Room closed (inactivity)."); return; }
                        if (now - created > TIMEOUT_DURATION) { setJoinedRoom(null); setError("Room closed (12h limit)."); return; }

                        // Messages
                        const msgs = data.messages || [];
                        setMessages(msgs);
                        if (!showChat && msgs.length > lastMsgCountRef.current) { setUnreadCount(prev => prev + (msgs.length - lastMsgCountRef.current)); }
                        lastMsgCountRef.current = msgs.length;

                        // Log
                        setRoomLog(data.log || []);

                        // Players
                        let playersData = data.players || {};
                        let currentPlayers = Array.isArray(playersData) ? playersData : Object.values(playersData);

                        const amIIn = currentPlayers.find(p => p.id === user.uid);

                        if (!amIIn) {
                            // FIX: Check if we are currently in the process of joining
                            if (isJoiningRef.current) {
                                // Ignore this snapshot, wait for the transaction to propagate
                                return;
                            }

                            // If I'm not in the list and not joining, I was kicked.
                            setJoinedRoom(null);
                            setError("You have left the room.");
                        } else {
                            // We are present, clear the joining flag
                            isJoiningRef.current = false;
                            setPlayers(currentPlayers);
                            playersRef.current = currentPlayers; // Update Ref for heartbeat
                        }
                    } else {
                        setError('Room does not exist!'); setJoinedRoom(null);
                    }
                }, (err) => setError(err.message));
                return () => unsubscribe();
            }, [joinedRoom, user, showChat]);

            useEffect(() => {
                if (showChat && chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                    setUnreadCount(0);
                }
            }, [showChat, messages]);

            const updateSelf = async (updates) => {
                if (!joinedRoom) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', joinedRoom);

                // Optimistic update
                const currentList = playersRef.current;
                const newPlayers = currentList.map(p => p.id === user.uid ? { ...p, ...updates } : p);
                setPlayers(newPlayers);
                playersRef.current = newPlayers;

                // Atomic Update
                const updatePayload = {};
                Object.entries(updates).forEach(([key, val]) => {
                    updatePayload[`players.${user.uid}.${key}`] = val;
                });
                updatePayload.lastActivity = serverTimestamp();

                await updateDoc(roomRef, updatePayload);
                if (updates.commander && joinedRoom !== "Test") updateCommanderStat(updates.commander);
                if (updates.partner && joinedRoom !== "Test") updateCommanderStat(updates.partner);
            };

            const isHost = roomData?.hostId === user.uid;

            // --- WINNER LOGIC RESTORED ---
            const activePlayers = players.filter(p => !p.isDead);
            // Winner condition: Only 1 active player left, and there were originally >1 players.
            const winnerId = (activePlayers.length === 1 && players.length > 1) ? activePlayers[0].id : null;

            // --- Stat Tracking Hook ---
            useEffect(() => {
                if (!isHost || !winnerId) return;

                // Only record if this is a new winner we haven't processed yet
                if (winnerId !== lastWinnerRef.current) {
                    lastWinnerRef.current = winnerId;

                    // Winner gets 1 win, 1 game played
                    incrementUserStats(winnerId, { wins: 1, gamesPlayed: 1 });

                    // Losers get 1 game played
                    players.forEach(p => {
                        if (p.id !== winnerId) {
                            incrementUserStats(p.id, { gamesPlayed: 1 });
                        }
                    });

                    // Announce in chat
                    const winnerName = players.find(p => p.id === winnerId)?.name || 'Unknown';
                    sendMessage(`🏆 Game Over! ${winnerName} wins! Stats have been recorded.`, null);
                }
            }, [winnerId, isHost, players]);

            // Heartbeat
            useEffect(() => {
                if (!joinedRoom) return;
                const interval = setInterval(() => {
                    // Uses the function which now uses the Ref, so it's always fresh
                    updateSelf({ lastHeartbeat: Date.now() });
                }, 5000);
                return () => clearInterval(interval);
            }, [joinedRoom]); // Only restart if room changes

            // Reaper Logic REMOVED per user request

            if (joinedRoom) {
                return (
                    <div className="h-full flex flex-col relative">
                        <div className="absolute top-4 right-4 md:right-8 z-30 flex items-center gap-2">
                            <button onClick={() => setShowToolsModal(true)} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full shadow-lg border border-slate-600 transition-colors">
                                <Icons.Dices className="w-5 h-5 text-purple-400" />
                            </button>
                            <button onClick={() => setShowHistoryModal(true)} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full shadow-lg border border-slate-600">
                                <Icons.Clock className="w-5 h-5 text-purple-400" />
                            </button>
                            <button onClick={() => { setShowChat(!showChat); if (!showChat) setUnreadCount(0); }} className="relative bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full shadow-lg border border-slate-600 transition-colors">
                                <Icons.MessageCircle className="w-5 h-5 text-purple-400" />
                                {unreadCount > 0 && (<div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-slate-900" />)}
                            </button>
                            <button onClick={() => setShowCardSearch(true)} className="bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full shadow-lg border border-slate-600 transition-colors flex items-center gap-2 px-4">
                                <Icons.Search className="w-4 h-4 text-purple-400" />
                                <span className="hidden md:inline text-sm font-bold">Database</span>
                            </button>
                        </div>

                        {showToolsModal && <GameToolsModal players={players} onClose={() => setShowToolsModal(false)} />}
                        {showHistoryModal && <HistoryModal log={roomLog} onClose={() => setShowHistoryModal(false)} />}

                        {showChat && (
                            <div className="absolute top-16 right-4 w-80 max-w-[calc(100vw-2rem)] h-[60vh] bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-40 flex flex-col animate-in fade-in slide-in-from-top-2">
                                <div className="p-3 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl"><span className="font-bold text-white text-sm">Room Chat</span><button onClick={() => setShowChat(false)}><Icons.X className="w-4 h-4 text-slate-400 hover:text-white" /></button></div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                    {messages.length === 0 && <div className="text-center text-xs text-slate-600 py-4">No messages yet.</div>}
                                    {messages.map((m, i) => (
                                        <ChatMessage key={i} msg={m} isMyMsg={m.sender === playerName} onViewCard={setViewingCard} />
                                    ))}
                                    <div ref={chatEndRef} />
                                </div>
                                <div className="p-2 border-t border-slate-700 bg-slate-800 rounded-b-xl flex gap-2"><input className="flex-1 bg-slate-900 border border-slate-600 text-white text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-purple-500" placeholder="Type a message..." value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && sendMessage()} /><button onClick={sendMessage} className="p-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-white"><Icons.Send className="w-4 h-4" /></button></div>
                            </div>
                        )}

                        {showCardSearch && <CardSearch onSelect={(card) => { setViewingCard(card); setShowCardSearch(false); sendMessage(`I found [${card.name}]`, card); }} onClose={() => setShowCardSearch(false)} mode="any" />}
                        {viewingCard && <CardDetailModal card={viewingCard} onClose={() => setViewingCard(null)} />}
                        {showCopiedToast && (<div className="absolute top-16 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-full shadow-lg z-50 animate-bounce">Link Copied!</div>)}

                        <div className="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center pr-24 md:pr-40">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2"><Icons.Wifi className="text-green-500 w-4 h-4 animate-pulse" /><span className="text-white font-bold">{joinedRoom}</span><span className="text-slate-500 text-sm">({players.length})</span></div>
                                <div className="flex gap-2">
                                    <button onClick={copyRoomLink} className="hidden md:flex items-center gap-1 text-xs bg-purple-600/20 text-purple-400 hover:bg-purple-600 hover:text-white px-3 py-1.5 rounded-full transition-colors font-medium border border-purple-500/50"><Icons.Share className="w-3 h-3" /> Share</button>
                                    {isHost && (
                                        <>
                                            <button
                                                onClick={() => { if (confirmClose) { closeRoom(); } else { setConfirmClose(true); setTimeout(() => setConfirmClose(false), 3000); } }}
                                                className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded-full transition-all font-medium border ${confirmClose ? 'bg-red-600 text-white border-red-600 scale-105' : 'bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white border-red-500/50'}`}
                                            >
                                                <Icons.Trash className="w-3 h-3" /> <span className="hidden md:inline">{confirmClose ? 'Confirm?' : 'Close'}</span>
                                            </button>
                                            <button
                                                onClick={() => { if (confirmReset) { resetGame(); } else { setConfirmReset(true); setTimeout(() => setConfirmReset(false), 3000); } }}
                                                className={`flex items-center gap-1 text-xs px-3 py-1.5 rounded-full transition-all font-medium border ${confirmReset ? 'bg-purple-600 text-white border-purple-600 scale-105' : 'bg-slate-700 text-slate-300 hover:bg-purple-600 hover:text-white border-slate-600'}`}
                                            >
                                                <Icons.Refresh className="w-3 h-3" /> <span className="hidden md:inline">{confirmReset ? 'Confirm?' : 'Reset'}</span>
                                            </button>
                                        </>
                                    )}
                                    <button onClick={handleLeaveRoom} className="flex items-center gap-1 text-xs bg-slate-700/50 text-slate-400 hover:bg-slate-700 hover:text-white px-3 py-1.5 rounded-full transition-colors font-medium border border-slate-600/50">
                                        <Icons.LogOut className="w-3 h-3" /> <span className="hidden md:inline">Leave</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {/* --- FIX 2: Mobile Scrolling Classes --- */}
                        <div className="absolute inset-0 top-16 flex flex-col p-4 scroll-container overflow-y-auto pb-24">
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr h-full min-h-[500px]">
                                {[...players].sort((a, b) => a.id.localeCompare(b.id)).map(p => (
                                    <PlayerCard
                                        key={p.id}
                                        {...p}
                                        isGuest={p.isGuest}
                                        players={players}
                                        isLocal={false}
                                        // --- WINNER PROP RESTORED ---
                                        isWinner={p.id === winnerId}
                                        color={p.id === user.uid ? 'bg-slate-800 ring-2 ring-purple-500' : 'bg-slate-800'}
                                        // Pass Kick Props
                                        canKick={isHost && p.id !== user.uid}
                                        onKick={() => handleKickPlayer(p.id)}
                                        onUpdate={(id, updates) => { if (id === user.uid) updateSelf(updates); }}
                                        onDead={(id) => { if (id === user.uid) updateSelf({ isDead: true }); }}
                                        onLog={addLogEntry}
                                        playerId={p.id} // Pass player ID for profile linking
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="absolute inset-0 flex flex-col p-4 md:p-8 overflow-y-auto scroll-container pb-24">
                    <button onClick={() => setShowCardSearch(true)} className="absolute top-4 right-4 md:right-8 bg-slate-800 hover:bg-slate-700 text-white p-2 rounded-full shadow-lg border border-slate-600 transition-colors z-20 flex items-center gap-2 px-4">
                        <Icons.Search className="w-4 h-4 text-purple-400" />
                        <span className="text-sm font-bold">Card Database</span>
                    </button>

                    {showCardSearch && <CardSearch onSelect={(card) => { setViewingCard(card); setShowCardSearch(false); }} onClose={() => setShowCardSearch(false)} mode="any" />}
                    {viewingCard && <CardDetailModal card={viewingCard} onClose={() => setViewingCard(null)} />}

                    <div className="max-w-4xl mx-auto w-full space-y-8 mt-12 md:mt-0">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-slate-900 p-6 rounded-2xl border border-slate-700">
                            <div className="flex items-center gap-4">
                                <div className="p-3 bg-purple-600/20 rounded-xl"><Icons.Users className="w-8 h-8 text-purple-500" /></div>
                                <div><h2 className="text-2xl font-bold text-white">Multiplayer Lobby</h2><p className="text-slate-400 text-sm">Join a game or host your own.</p></div>
                            </div>
                            <div className="w-full md:w-auto">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Your Display Name</label>
                                <input type="text" placeholder="Enter Your Name..." className="w-full md:w-64 bg-slate-800 border border-slate-600 text-white p-3 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none font-bold" value={playerName} onChange={(e) => updatePlayerName(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icons.Wifi className="w-5 h-5 text-green-500" /> Active Rooms</h3>
                                <div className="bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden min-h-[300px] flex flex-col">
                                    {rooms.length === 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center text-slate-500 p-8"><p>No active rooms found.</p><p className="text-sm">Be the first to host one!</p></div>
                                    ) : (
                                        <div className="divide-y divide-slate-800">
                                            {rooms.map(room => (
                                                <div key={room.id} onClick={() => { setSelectedRoomId(room.id); setHostName(''); }} className={`p-4 flex items-center justify-between cursor-pointer transition-colors ${selectedRoomId === room.id ? 'bg-purple-900/20 border-l-4 border-purple-500' : 'hover:bg-slate-800 border-l-4 border-transparent'}`}>
                                                    <div><div className="font-bold text-white">{room.name}</div><div className="text-xs text-slate-500">{room.playerCount || 0} Players</div></div>
                                                    <div className="flex items-center gap-3">
                                                        {room.password && <Icons.Lock className="w-4 h-4 text-orange-400" />}
                                                        {!room.password && <Icons.Unlock className="w-4 h-4 text-green-400/50" />}
                                                        <Icons.User className="w-5 h-5 text-slate-600" />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-6">
                                {selectedRoomId && (
                                    <div className="bg-slate-800 p-6 rounded-2xl border border-purple-500/50 shadow-lg animate-in fade-in slide-in-from-right-4">
                                        <h3 className="text-lg font-bold text-white mb-4">Join "{selectedRoomId}"</h3>
                                        <div className="space-y-4">
                                            {rooms.find(r => r.id === selectedRoomId)?.password && (
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 uppercase mb-1 block">Room Password</label>
                                                    <input type="password" placeholder="Required" className="w-full bg-slate-900 border border-slate-700 text-white p-3 rounded-lg outline-none focus:border-purple-500" value={joinPassword} onChange={(e) => setJoinPassword(e.target.value)} />
                                                </div>
                                            )}
                                            <button onClick={joinRoom} disabled={!user || !playerName} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">Join Game</button>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-slate-900 p-6 rounded-2xl border border-slate-700">
                                    <h3 className="text-lg font-bold text-white mb-4">Host New Room</h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Room Name</label>
                                            <input type="text" placeholder="e.g. Friday Night Magic" className="w-full bg-slate-800 border border-slate-600 text-white p-3 rounded-lg outline-none focus:border-purple-500" value={hostName} onChange={(e) => { setHostName(e.target.value); setSelectedRoomId(null); }} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Password (Optional)</label>
                                            <input type="text" placeholder="Leave empty for open room" className="w-full bg-slate-800 border border-slate-600 text-white p-3 rounded-lg outline-none focus:border-purple-500" value={hostPassword} onChange={(e) => setHostPassword(e.target.value)} />
                                        </div>
                                        <button onClick={createRoom} disabled={!user || !hostName || !playerName} className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">Create & Host</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {error && <div className="p-4 bg-red-900/50 border border-red-500 text-red-200 rounded-xl text-center font-bold animate-pulse">{error}</div>}
                    </div>
                </div>
            );
        };

        // 9. Changelog
        const Changelog = () => (
            <div className="absolute inset-0 p-8 max-w-3xl mx-auto text-slate-300 space-y-8 h-full overflow-y-auto scroll-container pb-24">
                <h1 className="text-3xl font-bold text-white mb-8">Patch Notes</h1>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-purple-500 ring-4 ring-slate-900" />
                    <div className="mb-1 text-purple-400 font-mono text-sm">v2.28.0 - Game Enhancements</div>
                    <h3 className="text-xl font-bold text-white mb-2">New Features</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Game Timer:</strong> A live clock now appears during local games with pause/reset controls.</li>
                        <li><strong className="text-slate-200">Undo / Redo:</strong> Full undo/redo support (Ctrl+Z / Ctrl+Y) for life total and counter changes.</li>
                        <li><strong className="text-slate-200">Life History:</strong> Tap the 📊 button on any player card to see a graph of their life total over the game.</li>
                        <li><strong className="text-slate-200">Mulligan Tracker:</strong> Track mulligans per player from the Counters panel — badge shown on card.</li>
                        <li><strong className="text-slate-200">Commander Damage Alerts:</strong> Badges turn amber at 16+ damage and flash red at lethal (21+).</li>
                        <li><strong className="text-slate-200">Export Stats Card:</strong> Share your global stats as a shareable image from the Stats page.</li>
                        <li><strong className="text-slate-200">Theme System:</strong> Choose from Dark Purple (default), Light, or Dark Red themes in Settings.</li>
                    </ul>
                </div>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 ring-4 ring-slate-900" />
                    <div className="mb-1 text-slate-500 font-mono text-sm">v2.27.0 - Stability & UX</div>
                    <h3 className="text-xl font-bold text-white mb-2">Bug Fixes & Improvements</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Stable Player Panels:</strong> Fixed player panels constantly switching positions in multiplayer lobbies.</li>
                        <li><strong className="text-slate-200">Green Usernames:</strong> Logged-in users now display with green usernames to distinguish them from guests.</li>
                        <li><strong className="text-slate-200">Host Button Fix:</strong> Close and Reset buttons now remain visible consistently for room hosts.</li>
                        <li><strong className="text-slate-200">Guest Flow:</strong> Guest users are no longer prompted to set a username (reserved for registered users).</li>
                    </ul>
                </div>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 ring-4 ring-slate-900" />
                    <div className="mb-1 text-slate-500 font-mono text-sm">v2.26.0 - Social & Style</div>
                    <h3 className="text-xl font-bold text-white mb-2">Profiles & Leaderboards</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Public Profiles:</strong> You can now view other players' profiles and Follow them!</li>
                        <li><strong className="text-slate-200">Unique URLs:</strong> Share your profile with a unique link (e.g., <code>?profile=MyName</code>).</li>
                        <li><strong className="text-slate-200">Global Leaderboard:</strong> See who has played the most games on the Stats page.</li>
                        <li><strong className="text-slate-200">Color Identity:</strong> Show off your favorite MTG colors on your profile.</li>
                    </ul>
                </div>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 ring-4 ring-slate-900" />
                    <div className="mb-1 text-slate-500 font-mono text-sm">v2.25.0 - Quality of Life</div>
                    <h3 className="text-xl font-bold text-white mb-2">Game Improvements</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Who Goes First?:</strong> Added a dice and randomizer tool to help decide the starting player.</li>
                        <li><strong className="text-slate-200">Card Sharing:</strong> Looking up a card in the lobby now automatically shares it in the chat.</li>
                        <li><strong className="text-slate-200">Stability:</strong> Improved player connection handling to prevent life resets.</li>
                    </ul>
                </div>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-purple-500 ring-4 ring-slate-900" />
                    <div className="mb-1 text-purple-400 font-mono text-sm">v2.24.1 - Admin Power</div>
                    <h3 className="text-xl font-bold text-white mb-2">Room Management</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">No More Timeouts:</strong> Automatic removal for inactivity has been disabled. Players stay until they leave.</li>
                        <li><strong className="text-slate-200">Kick Feature:</strong> The Room Host can now manually remove players via the Tools (wrench) menu on a player's card.</li>
                    </ul>
                </div>
                <div className="relative pl-8 border-l-2 border-slate-700">
                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 ring-4 ring-slate-900" />
                    <div className="mb-1 text-slate-500 font-mono text-sm">v2.24.0 - Partners!</div>
                    <h3 className="text-xl font-bold text-white mb-2">Partner Commanders</h3>
                    <ul className="list-disc pl-4 space-y-2 text-slate-400">
                        <li><strong className="text-slate-200">Added Partners:</strong> You can now check "Add as Partner" when searching for a commander to add a second commander to your board.</li>
                        <li><strong className="text-slate-200">Damage Tracking:</strong> Opponents with partners now show two separate commander damage counters in the tools menu.</li>
                    </ul>
                </div>
            </div>
        );

        // --- Local Setup Component ---
        const LocalSetup = ({ onStart }) => (
            <div className="h-full flex flex-col items-center justify-center p-8 animate-in fade-in">
                <div className="bg-slate-900 p-8 rounded-2xl border border-slate-700 shadow-2xl max-w-md w-full text-center">
                    <Icons.Users className="w-16 h-16 text-purple-500 mx-auto mb-6" />
                    <h2 className="text-3xl font-bold text-white mb-2">Local Game</h2>
                    <p className="text-slate-400 mb-8">How many players?</p>

                    <div className="grid grid-cols-2 gap-4">
                        {[2, 3, 4, 5, 6].map(num => (
                            <button
                                key={num}
                                onClick={() => onStart(num)}
                                className="bg-slate-800 hover:bg-purple-600 text-white font-bold py-4 rounded-xl text-xl transition-all border border-slate-700 hover:border-purple-500"
                            >
                                {num} Players
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        );

        // --- Main App ---
        function App() {
            // !!! ADDED FOR BACKGROUND UPDATES !!!
            useBackgroundHeartbeat();

            const [user, setUser] = useState(null);

            // --- Check URL for Room Param ---
            const [view, setView] = useState(() => {
                if (typeof window !== 'undefined') {
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('room')) return 'online';
                    if (params.get('profile')) return 'profile';
                }
                return 'local';
            });

            // If view is profile, `viewProfileId` can be a UID or a Username
            const [viewProfileId, setViewProfileId] = useState(() => {
                if (typeof window !== 'undefined') {
                    const params = new URLSearchParams(window.location.search);
                    return params.get('profile') || null;
                }
                return null;
            });

            // Expose a global way to set view profile
            useEffect(() => {
                window.setViewProfile = (idOrName) => {
                    setViewProfileId(idOrName);
                    setView('profile');
                    // Update URL with username or ID
                    const newUrl = idOrName ? `?profile=${idOrName}` : '?profile';
                    window.history.pushState({}, '', newUrl);
                };
            }, []);

            const [isLocalSetup, setIsLocalSetup] = useState(true);
            const [localPlayers, setLocalPlayers] = useState([]);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [localLog, setLocalLog] = useState([]);
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);

            const [showLocalMenu, setShowLocalMenu] = useState(false);
            const [showToolsModal, setShowToolsModal] = useState(false);
            const [showHistoryModal, setShowHistoryModal] = useState(false);
            const [showCardSearch, setShowCardSearch] = useState(false);
            const [viewingCard, setViewingCard] = useState(null);

            // Undo / Redo
            const undoStack = useRef([]);
            const redoStack = useRef([]);

            // Game Timer
            const timer = useGameTimer();

            const saveSnapshot = (players) => {
                undoStack.current.push(JSON.parse(JSON.stringify(players)));
                if (undoStack.current.length > 20) undoStack.current.shift();
                redoStack.current = [];
            };

            const undoLocalGame = () => {
                if (undoStack.current.length === 0) return;
                redoStack.current.push(JSON.parse(JSON.stringify(localPlayers)));
                setLocalPlayers(undoStack.current.pop());
                addLocalLog('↩ Undo');
            };

            const redoLocalGame = () => {
                if (redoStack.current.length === 0) return;
                undoStack.current.push(JSON.parse(JSON.stringify(localPlayers)));
                setLocalPlayers(redoStack.current.pop());
                addLocalLog('↪ Redo');
            };

            // Ctrl+Z / Ctrl+Y keyboard shortcuts
            useEffect(() => {
                const handler = (e) => {
                    if (!isLocalSetup && (e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey) && !e.shiftKey) { e.preventDefault(); undoLocalGame(); }
                    if (!isLocalSetup && ((e.key === 'y' || e.key === 'Y') && (e.ctrlKey || e.metaKey)) || ((e.key === 'z' || e.key === 'Z') && (e.ctrlKey || e.metaKey) && e.shiftKey)) { e.preventDefault(); redoLocalGame(); }
                };
                window.addEventListener('keydown', handler);
                return () => window.removeEventListener('keydown', handler);
            }, [isLocalSetup, localPlayers]);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        // Also try fetch profile?
                    } else {
                        // FIX: Do NOT auto sign-in anonymously if we want an auth gate
                        setUser(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            if (!user) {
                return <AuthPage />;
            }

            // Check for Username/Display Name
            // We use a simple check: if auth.currentUser.displayName is missing, prompt setup.
            // But better to check firestore doc for robust sync. 
            // For now, let's rely on auth.currentUser.displayName as primary signal because we update it on setup.
            // Skip username prompt for anonymous users (guests)
            if (!user.isAnonymous && !user.displayName) {
                return <UsernameSetup user={user} onComplete={(name) => {
                    // Force refresh of user state to pick up the new displayName
                    setUser({ ...user, displayName: name });
                }} />;
            }

            const startLocalGame = (count) => {
                const newPlayers = Array.from({ length: count }, (_, i) => ({
                    id: i + 1, name: `P${i + 1}`, life: 40, startLife: 40, commander: null, color: 'bg-slate-800', poison: 0, milled: false, commanderDamage: {}, isDead: false, mulligans: 0, lifeHistory: []
                }));
                undoStack.current = [];
                redoStack.current = [];
                setLocalPlayers(newPlayers);
                setLocalLog([]);
                addLocalLog(`Started ${count}-player game`);
                setIsLocalSetup(false);
                setShowLocalMenu(false);
                timer.restart();
            };

            const resetLocalGame = () => { setIsLocalSetup(true); setShowLocalMenu(false); };
            const addLocalLog = (msg) => { setLocalLog(prev => [...prev, { timestamp: Date.now(), message: msg }]); };

            const updateLocalPlayer = (id, updates) => {
                setLocalPlayers(prev => {
                    saveSnapshot(prev);
                    return prev.map(p => {
                        if (p.id !== id) return p;
                        const updated = { ...p, ...updates };
                        if (typeof updates.life !== 'undefined' || typeof updates.poison !== 'undefined' || updates.commanderDamage || typeof updates.milled !== 'undefined') {
                            const deadByPoison = updated.poison >= 10;
                            const deadByCmdr = Object.values(updated.commanderDamage || {}).some(dmg => dmg >= 21);
                            const deadByLife = updated.life <= 0;
                            updated.isDead = deadByPoison || deadByCmdr || deadByLife || updated.milled;
                        }
                        return updated;
                    });
                });
            };

            const NavItem = ({ id, label, icon: Icon }) => (
                <button onClick={() => { setView(id); setIsMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${view === id ? 'bg-purple-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-800 hover:text-white'} ${isSidebarCollapsed ? 'justify-center px-2' : ''}`}>
                    <Icon className="w-5 h-5 flex-shrink-0" />
                    {!isSidebarCollapsed && label}
                </button>
            );

            // Determine Winner for Local Game
            const activePlayers = localPlayers.filter(p => !p.isDead);
            const winnerId = (!isLocalSetup && activePlayers.length === 1 && localPlayers.length > 1) ? activePlayers[0].id : null;

            return (
                <div className="bg-slate-950 min-h-screen text-slate-200 font-sans selection:bg-purple-500/30 overflow-hidden flex flex-col">
                    <div className="md:hidden bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center z-20">
                        <div className="flex items-center gap-2 text-white font-bold text-lg">
                            <Icons.Shield className="text-purple-500 fill-current w-6 h-6" />
                            <span>Companion</span>
                        </div>
                        <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="p-2 text-white">
                            {isMenuOpen ? <Icons.X className="w-6 h-6" /> : <Icons.Menu className="w-6 h-6" />}
                        </button>
                    </div>

                    <div className="flex flex-1 overflow-hidden relative">
                        <div className={`fixed md:relative inset-y-0 left-0 ${isSidebarCollapsed ? 'w-20' : 'w-64'} bg-slate-900 border-r border-slate-800 transform transition-transform duration-300 z-30 flex flex-col ${isMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                            <div className="p-4 border-b border-slate-800 hidden md:flex items-center justify-between">
                                <div className={`flex items-center gap-3 ${isSidebarCollapsed ? 'justify-center w-full' : ''}`}>
                                    <div className="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-purple-500/20 flex-shrink-0">
                                        <Icons.Shield className="text-white w-6 h-6" />
                                    </div>
                                    {!isSidebarCollapsed && (
                                        <div className="overflow-hidden whitespace-nowrap">
                                            <h1 className="font-bold text-white text-lg leading-tight">Commander</h1>
                                            <div className="text-xs text-purple-400 font-medium">Companion App</div>
                                        </div>
                                    )}
                                </div>
                                {!isSidebarCollapsed && <button onClick={() => setIsSidebarCollapsed(true)} className="text-slate-500 hover:text-white"><Icons.ChevronLeft className="w-5 h-5" /></button>}
                            </div>
                            {isSidebarCollapsed && (
                                <div className="p-2 flex justify-center border-b border-slate-800">
                                    <button onClick={() => setIsSidebarCollapsed(false)} className="text-slate-500 hover:text-white p-2"><Icons.ChevronRight className="w-5 h-5" /></button>
                                </div>
                            )}

                            <div className="p-4 space-y-2 flex-1">
                                {!isSidebarCollapsed && <div className="text-xs font-bold text-slate-500 uppercase tracking-wider px-4 mb-2 mt-4">Game Modes</div>}
                                <NavItem id="local" label="Local Game" icon={Icons.Users} />
                                <NavItem id="online" label="Online Room" icon={Icons.Wifi} />
                                {!isSidebarCollapsed && <div className="text-xs font-bold text-slate-500 uppercase tracking-wider px-4 mb-2 mt-6">Data & Info</div>}
                                <NavItem id="profile" label="My Profile" icon={Icons.User} />
                                <NavItem id="stats" label="Global Stats" icon={Icons.BarChart2} />
                                <NavItem id="settings" label="Settings" icon={Icons.Sliders} />
                                <NavItem id="contact" label="Contact" icon={Icons.Mail} />
                                <NavItem id="changes" label="Changelog" icon={Icons.FileText} />
                            </div>

                            <div className="p-4 border-t border-slate-800">
                                {view === 'local' && (
                                    <button onClick={resetLocalGame} className={`w-full flex items-center gap-2 bg-slate-800 hover:bg-red-900/30 text-slate-300 hover:text-red-400 p-3 rounded-lg transition-colors border border-slate-700 hover:border-red-800 ${isSidebarCollapsed ? 'justify-center' : 'justify-center'}`}>
                                        <Icons.RotateCcw className="w-4 h-4" />
                                        {!isSidebarCollapsed && <span>Reset Game</span>}
                                    </button>
                                )}
                                {!isSidebarCollapsed && <div className="mt-4 text-center text-xs text-slate-600">{user ? `ID: ${user.uid.slice(0, 6)}...` : 'Connecting...'}</div>}
                            </div>
                        </div>

                        {isMenuOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={() => setIsMenuOpen(false)} />}

                        {/* --- FIX 2: Added min-h-0 to allow proper flex scrolling on Android --- */}
                        <main className="flex-1 relative overflow-hidden bg-slate-950 flex flex-col min-h-0">
                            {view === 'local' && (
                                <>
                                    {isLocalSetup ? (
                                        <LocalSetup onStart={startLocalGame} />
                                    ) : (
                                        <div className="relative h-full w-full">
                                            {/* Game Timer HUD */}
                                            <div className="absolute top-0 left-0 right-0 z-30 flex items-center justify-center gap-3 p-2 bg-black/30 backdrop-blur-sm pointer-events-none">
                                                <span className="font-mono text-white font-bold tracking-widest text-lg drop-shadow">{timer.display}</span>
                                                <div className="flex gap-1 pointer-events-auto">
                                                    <button onClick={timer.isRunning ? timer.pause : timer.start} className="p-1 bg-white/10 hover:bg-white/20 rounded-full text-white/80 text-xs transition">{timer.isRunning ? '⏸' : '▶'}</button>
                                                    <button onClick={timer.reset} className="p-1 bg-white/10 hover:bg-white/20 rounded-full text-white/80 text-xs transition">🔄</button>
                                                </div>
                                            </div>

                                            <div className={`absolute inset-0 grid gap-2 p-2 pt-16 pb-20 overflow-y-auto scroll-container ${localPlayers.length <= 2 ? 'grid-cols-1 sm:grid-cols-2' :
                                                localPlayers.length <= 4 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-2' :
                                                    'grid-cols-2 lg:grid-cols-3'
                                                }`}>
                                                {localPlayers.map(p => (
                                                    <PlayerCard
                                                        key={p.id}
                                                        {...p}
                                                        isLocal={true}
                                                        isWinner={p.id === winnerId}
                                                        players={localPlayers}
                                                        onUpdate={updateLocalPlayer}
                                                        onDead={(id) => updateLocalPlayer(id, { isDead: true })}
                                                        onLog={addLocalLog}
                                                    />
                                                ))}
                                            </div>

                                            {/* Center Tool Button (Floating) */}
                                            <div className="absolute inset-0 pointer-events-none z-40 flex items-center justify-center">
                                                <div className="pointer-events-auto relative flex flex-col items-center">
                                                    <button
                                                        onClick={() => setShowLocalMenu(!showLocalMenu)}
                                                        className={`p-4 rounded-full shadow-2xl transition-all duration-300 border-4 border-slate-900 ${showLocalMenu ? 'bg-purple-600 rotate-90 scale-110' : 'bg-slate-800 hover:bg-slate-700'}`}
                                                    >
                                                        <Icons.Wrench className="w-6 h-6 text-white" />
                                                    </button>

                                                    {/* Radial/Popout Menu Options */}
                                                    {showLocalMenu && (
                                                        <div className="absolute flex flex-col gap-3 items-center" style={{ top: '4.5rem' }}>
                                                            <button
                                                                onClick={resetLocalGame}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-red-600 transition-colors animate-in fade-in slide-in-from-top-2 whitespace-nowrap"
                                                            >
                                                                <Icons.RotateCcw className="w-4 h-4" /> New Game
                                                            </button>
                                                            <button
                                                                onClick={undoLocalGame}
                                                                disabled={undoStack.current.length === 0}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-blue-600 transition-colors animate-in fade-in slide-in-from-top-2 delay-[30ms] whitespace-nowrap disabled:opacity-40"
                                                            >
                                                                <Icons.Undo className="w-4 h-4" /> Undo
                                                            </button>
                                                            <button
                                                                onClick={redoLocalGame}
                                                                disabled={redoStack.current.length === 0}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-blue-600 transition-colors animate-in fade-in slide-in-from-top-2 delay-[60ms] whitespace-nowrap disabled:opacity-40"
                                                            >
                                                                <Icons.Redo className="w-4 h-4" /> Redo
                                                            </button>
                                                            <button
                                                                onClick={() => { setShowToolsModal(true); setShowLocalMenu(false); }}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-purple-600 transition-colors animate-in fade-in slide-in-from-top-2 delay-75 whitespace-nowrap"
                                                            >
                                                                <Icons.Dices className="w-4 h-4" /> Tools
                                                            </button>
                                                            <button
                                                                onClick={() => { setShowHistoryModal(true); setShowLocalMenu(false); }}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-purple-600 transition-colors animate-in fade-in slide-in-from-top-2 delay-100 whitespace-nowrap"
                                                            >
                                                                <Icons.Clock className="w-4 h-4" /> History
                                                            </button>
                                                            <button
                                                                onClick={() => { setShowCardSearch(true); setShowLocalMenu(false); }}
                                                                className="flex items-center gap-2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-slate-700 hover:bg-purple-600 transition-colors animate-in fade-in slide-in-from-top-2 delay-150 whitespace-nowrap"
                                                            >
                                                                <Icons.Search className="w-4 h-4" /> Database
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                            {view === 'online' && <OnlineRoom user={user} onLeave={() => setView('local')} />}
                            {view === 'profile' && <ProfilePage user={user} viewProfileId={viewProfileId} onBack={() => { setViewProfileId(null); setView('local'); window.history.pushState({}, '', '/'); }} />}
                            {view === 'stats' && <StatsPage user={user} />}
                            {view === 'settings' && <SettingsPage />}
                            {view === 'contact' && <ContactPage />}
                            {view === 'changes' && <Changelog />}

                            {/* Global/Local Modals for Local View */}
                            {view === 'local' && !isLocalSetup && showToolsModal && <GameToolsModal players={localPlayers} onClose={() => setShowToolsModal(false)} />}
                            {view === 'local' && !isLocalSetup && showHistoryModal && <HistoryModal log={localLog} onClose={() => setShowHistoryModal(false)} />}
                            {view === 'local' && showCardSearch && <CardSearch
                                onSelect={(card, asPartner) => {
                                    setViewingCard(card);
                                    // Local game partner logic isn't fully wired here, but card search works for general browsing
                                    setShowCardSearch(false);
                                }}
                                onClose={() => setShowCardSearch(false)}
                                mode="any"
                            />}
                            {view === 'local' && viewingCard && <CardDetailModal card={viewingCard} onClose={() => setViewingCard(null)} />}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThemeProvider><App /></ThemeProvider>);
    </script>
</body>

</html>